<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ• æ¥ç¦ç‹—è´ªåƒå¤§ä½œæˆ˜</title>

    <!-- PWAæ”¯æŒ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8B7EC8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ¥ç¦è´ªåƒè›‡">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
jishi        }

        /* è£…é¥°å›¾ç‰‡æ ·å¼ */
        .decoration-dog {
pen'guonguo            position: absolute;
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            opacity: 0.8;
            z-index: 1;
            pointer-events: none;
            transition: opacity 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .decoration-dog:hover {
            opacity: 1;
        }
        
        /* ä¸»èœå•è£…é¥° - å·¦è¾¹3å¼ å³è¾¹3å¼  */
        .main-menu-decoration {
            position: absolute;
        }
        
        .dog1 {
            top: 20px;
            left: 20px;
            width: 80px;
            height: 60px;
        }
        
        .dog2 {
            top: 20px;
            right: 20px;
            width: 80px;
            height: 60px;
        }
        
        .dog4 {
            top: 100px;
            left: 20px;
            width: 80px;
            height: 60px;
        }
        
        .dog5 {
            top: 100px;
            right: 20px;
            width: 80px;
            height: 60px;
        }
        
        .dog6 {
            top: 180px;
            left: 20px;
            width: 80px;
            height: 60px;
        }
        
        .dog7 {
            top: 180px;
            right: 20px;
            width: 80px;
            height: 60px;
        }
        
        /* å…³å¡é€‰æ‹©è£…é¥° - å·¦è¾¹3å¼ å³è¾¹3å¼  */
        .level-decoration {
            position: absolute;
        }
        
        .level-dog1 {
            top: 15px;
            left: 15px;
            width: 75px;
            height: 55px;
        }
        
        .level-dog2 {
            top: 15px;
            right: 15px;
            width: 75px;
            height: 55px;
        }
        
        .level-dog4 {
            top: 90px;
            left: 15px;
            width: 75px;
            height: 55px;
        }
        
        .level-dog5 {
            top: 90px;
            right: 15px;
            width: 75px;
            height: 55px;
        }
        
        .level-dog6 {
            top: 165px;
            left: 15px;
            width: 75px;
            height: 55px;
        }
        
        .level-dog7 {
            top: 165px;
            right: 15px;
            width: 75px;
            height: 55px;
        }
        
        /* æ¸¸æˆç•Œé¢è£…é¥° - å·¦è¾¹3å¼ å³è¾¹3å¼  */
        .game-decoration {
            position: absolute;
        }
        
        .game-dog1 {
            top: 10px;
            left: 10px;
            width: 70px;
            height: 50px;
        }
        
        .game-dog2 {
            top: 10px;
            right: 10px;
            width: 70px;
            height: 50px;
        }
        
        .game-dog4 {
            top: 80px;
            left: 10px;
            width: 70px;
            height: 50px;
        }
        
        .game-dog5 {
            top: 80px;
            right: 10px;
            width: 70px;
            height: 50px;
        }
        
        .game-dog6 {
            top: 150px;
            left: 10px;
            width: 70px;
            height: 50px;
        }
        
        .game-dog7 {
            top: 150px;
            right: 10px;
            width: 70px;
            height: 50px;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .decoration-dog {
                width: 50px;
                height: 38px;
            }
            
            .dog1, .dog2, .dog4, .dog5, .dog6, .dog7 {
                width: 50px;
                height: 38px;
            }
            
            .dog4 { top: 80px; }
            .dog5 { top: 80px; }
            .dog6 { top: 140px; }
            .dog7 { top: 140px; }
            
            .game-dog1, .game-dog2, .game-dog4, .game-dog5, .game-dog6, .game-dog7 {
                width: 45px;
                height: 35px;
            }
            
            .game-dog4 { top: 65px; }
            .game-dog5 { top: 65px; }
            .game-dog6 { top: 120px; }
            .game-dog7 { top: 120px; }
            
            .level-dog1, .level-dog2, .level-dog4, .level-dog5, .level-dog6, .level-dog7 {
                width: 48px;
                height: 36px;
            }
            
            .level-dog4 { top: 70px; }
            .level-dog5 { top: 70px; }
            .level-dog6 { top: 125px; }
            .level-dog7 { top: 125px; }
        }
        
        .game-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* ä¸»èœå•æ ·å¼ */
        .main-menu {
            color: white;
        }
        
        .main-menu h2 {
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        /* å…³å¡é€‰æ‹©ç•Œé¢æ ·å¼ */
        .level-select {
            color: white;
        }
        
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .level-card {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .level-card:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .level-card.locked {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .level-card.completed {
            background: rgba(0, 255, 0, 0.2);
            border-color: rgba(0, 255, 0, 0.5);
        }
        
        .level-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .level-name {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .level-status {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .lock-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
        }
        
        .star-rating {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
            color: #FFD700;
        }
        
        /* æ¸¸æˆç•Œé¢æ ·å¼ */
        .game-screen {
            color: white;
        }
        
        .level-info {
            color: white;
            font-size: 18px;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .score {
            color: white;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .target-score {
            color: #FFD700;
            font-size: 16px;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .timer {
            color: #FF6B6B;
            font-size: 18px;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        #gameCanvas {
            border: 3px solid white;
            border-radius: 10px;
            background: #2c3e50;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            max-width: 100%;
            height: auto;
        }
        
        /* ç§»åŠ¨ç«¯æ§åˆ¶æŒ‰é’® */
        .mobile-controls {
            display: none;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .mobile-controls {
                display: block;
            }
        }
        
        .direction-pad {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 5px;
            max-width: 150px;
            margin: 0 auto 15px;
        }
        
        .direction-btn {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            border-radius: 10px;
            color: white;
            font-size: 20px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            touch-action: manipulation;
        }
        
        .direction-btn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.95);
        }
        
        .direction-btn.up {
            grid-column: 2;
            grid-row: 1;
        }
        
        .direction-btn.left {
            grid-column: 1;
            grid-row: 2;
        }
        
        .direction-btn.right {
            grid-column: 3;
            grid-row: 2;
        }
        
        .direction-btn.down {
            grid-column: 2;
            grid-row: 3;
        }
        
        .controls {
            margin-top: 15px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: clamp(12px, 3vw, 16px);
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .btn:hover, .btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .btn.primary {
            background: rgba(0, 123, 255, 0.6);
            border-color: #007bff;
        }
        
        .btn.primary:hover, .btn.primary:active {
            background: rgba(0, 123, 255, 0.8);
        }
        
        .game-over, .level-complete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 1000;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .level-complete {
            background: rgba(0, 128, 0, 0.9);
        }
        
        .house-hint {
            color: #FFD700;
            font-size: clamp(12px, 3vw, 14px);
            margin-top: 8px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        
        .debug {
            color: #ccc;
            font-size: clamp(10px, 2.5vw, 12px);
            margin-top: 8px;
        }
        
        .progress-info {
            color: #FFD700;
            font-size: clamp(12px, 3vw, 14px);
            margin-bottom: 15px;
        }
        
        .star-display {
            font-size: 24px;
            margin: 10px 0;
        }
        
        .time-display {
            color: #FFD700;
            font-size: 16px;
            margin: 5px 0;
        }
        
        /* è§¦æ‘¸æ»‘åŠ¨æ§åˆ¶æç¤º */
        .touch-hint {
            color: rgba(255, 255, 255, 0.7);
            font-size: clamp(10px, 2.5vw, 12px);
            margin-top: 5px;
        }
        
        @media (min-width: 769px) {
            .touch-hint {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>ğŸ• æ¥ç¦ç‹—è´ªåƒå¤§ä½œæˆ˜</h1>
        
        <!-- ä¸»èœå• -->
        <div id="mainMenu" class="screen main-menu active">
            <!-- è£…é¥°å›¾ç‰‡ -->
            <img src="dog1.jpg.jpg" alt="" class="decoration-dog main-menu-decoration dog1">
            <img src="dog2.jpg.png" alt="" class="decoration-dog main-menu-decoration dog2">
            <img src="dog4.jpg.jpg" alt="" class="decoration-dog main-menu-decoration dog4">
            <img src="dog5.jpg.jpg" alt="" class="decoration-dog main-menu-decoration dog5">
            <img src="dog6.jpg.jpg" alt="" class="decoration-dog main-menu-decoration dog6">
            <img src="dog7.jpg.jpg" alt="" class="decoration-dog main-menu-decoration dog7">
            
            <h2>æ¬¢è¿æ¥åˆ°æ¥ç¦çš„å†’é™©ä¹‹æ—…ï¼</h2>
            <div class="progress-info">
                å·²è§£é”å…³å¡: <span id="unlockedLevels">1</span> / 5
            </div>
            <button class="btn primary" onclick="showLevelSelect()">é€‰æ‹©å…³å¡</button>
            <button class="btn" onclick="startQuickGame()">å¿«é€Ÿå¼€å§‹</button>
            <button class="btn" onclick="resetProgress()">é‡ç½®è¿›åº¦</button>
        </div>
        
        <!-- å…³å¡é€‰æ‹©ç•Œé¢ -->
        <div id="levelSelect" class="screen level-select">
            <!-- è£…é¥°å›¾ç‰‡ -->
            <img src="dog1.jpg.jpg" alt="" class="decoration-dog level-decoration level-dog1">
            <img src="dog2.jpg.png" alt="" class="decoration-dog level-decoration level-dog2">
            <img src="dog4.jpg.jpg" alt="" class="decoration-dog level-decoration level-dog4">
            <img src="dog5.jpg.jpg" alt="" class="decoration-dog level-decoration level-dog5">
            <img src="dog6.jpg.jpg" alt="" class="decoration-dog level-decoration level-dog6">
            <img src="dog7.jpg.jpg" alt="" class="decoration-dog level-decoration level-dog7">
            
            <h2>é€‰æ‹©å…³å¡</h2>
            <div class="level-grid" id="levelGrid">
                <!-- å…³å¡å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button class="btn" onclick="showMainMenu()">è¿”å›ä¸»èœå•</button>
        </div>
        
        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="gameScreen" class="screen game-screen">
            <!-- è£…é¥°å›¾ç‰‡ -->
            <img src="dog1.jpg.jpg" alt="" class="decoration-dog game-decoration game-dog1">
            <img src="dog2.jpg.png" alt="" class="decoration-dog game-decoration game-dog2">
            <img src="dog4.jpg.jpg" alt="" class="decoration-dog game-decoration game-dog4">
            <img src="dog5.jpg.jpg" alt="" class="decoration-dog game-decoration game-dog5">
            <img src="dog6.jpg.jpg" alt="" class="decoration-dog game-decoration game-dog6">
            <img src="dog7.jpg.jpg" alt="" class="decoration-dog game-decoration game-dog7">
            
            <div class="level-info">å…³å¡ <span id="currentLevel">1</span> - <span id="levelName">æ–°æ‰‹æ‘</span></div>
            <div class="target-score">ç›®æ ‡åˆ†æ•°: <span id="targetScore">50</span></div>
            <div class="score">å¾—åˆ†: <span id="score">0</span></div>
            <div class="timer">æ—¶é—´: <span id="timer">00:00</span></div>
            <div id="houseHint" class="house-hint" style="display: none;">ğŸ  æ‰¾åˆ°å®¶å¹¶åƒæ‰å®ƒé€šå…³ï¼</div>
            <div id="debugInfo" class="debug">çŠ¶æ€: å‡†å¤‡å°±ç»ª</div>
            <canvas id="gameCanvas" width="320" height="320"></canvas>
            
            <!-- ç§»åŠ¨ç«¯æ§åˆ¶æŒ‰é’® -->
            <div class="mobile-controls">
                <div class="direction-pad">
                    <button class="direction-btn up" ontouchstart="changeDirection('up')" onclick="changeDirection('up')">â†‘</button>
                    <button class="direction-btn left" ontouchstart="changeDirection('left')" onclick="changeDirection('left')">â†</button>
                    <button class="direction-btn right" ontouchstart="changeDirection('right')" onclick="changeDirection('right')">â†’</button>
                    <button class="direction-btn down" ontouchstart="changeDirection('down')" onclick="changeDirection('down')">â†“</button>
                </div>
                <div class="touch-hint">ä¹Ÿå¯ä»¥åœ¨æ¸¸æˆåŒºåŸŸæ»‘åŠ¨æ§åˆ¶æ–¹å‘</div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
                <button class="btn" onclick="pauseGame()">æš‚åœ/ç»§ç»­</button>
                <button class="btn" onclick="showLevelSelect()">é€‰æ‹©å…³å¡</button>
                <button class="btn" onclick="showMainMenu()">ä¸»èœå•</button>
            </div>
        </div>
        
        <div class="game-over" id="gameOver">
            <h2>æ¸¸æˆç»“æŸ!</h2>
            <p>æœ€ç»ˆå¾—åˆ†: <span id="finalScore">0</span></p>
            <div class="time-display">ç”¨æ—¶: <span id="finalTime">00:00</span></div>
            <button class="btn" onclick="startGame()">é‡æ–°å¼€å§‹</button>
            <button class="btn" onclick="gameOverToLevelSelect()">é€‰æ‹©å…³å¡</button>
        </div>
        
        <div class="level-complete" id="levelComplete">
            <h2>ğŸ‰ å…³å¡å®Œæˆ!</h2>
            <p>æ­å–œé€šè¿‡ <span id="completedLevel"></span>!</p>
            <p>å¾—åˆ†: <span id="levelScore">0</span></p>
            <div class="time-display">ç”¨æ—¶: <span id="completionTime">00:00</span></div>
            <div class="star-display" id="starDisplay">â­â­â­</div>
            <div id="unlockMessage" style="display: none;">
                <p style="color: #FFD700;">ğŸŠ è§£é”æ–°å…³å¡ï¼</p>
            </div>
            <button class="btn" onclick="nextLevel()">ä¸‹ä¸€å…³</button>
            <button class="btn" onclick="startGame()">é‡ç©æœ¬å…³</button>
            <button class="btn" onclick="levelCompleteToLevelSelect()">é€‰æ‹©å…³å¡</button>
        </div>
    </div>

    <script>
        // æ³¨å†ŒService Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // å…¨å±€å˜é‡
        let canvas, ctx, scoreElement, gameOverElement, levelCompleteElement;
        let finalScoreElement, currentLevelElement, levelNameElement, targetScoreElement;
        let houseHintElement, debugInfo, timerElement;
        
        // æ¸¸æˆé…ç½®
        const gridSize = 16; // ç§»åŠ¨ç«¯é€‚é…ï¼Œç¨å¾®å°ä¸€ç‚¹
        let tileCount = 20;
        

        
        // å…³å¡é…ç½®
        const levels = [
            { name: "æ–°æ‰‹æ‘", targetScore: 50, speed: 200, obstacles: [] }, // ç§»åŠ¨ç«¯ç¨å¾®æ…¢ä¸€ç‚¹
            { name: "æ£®æ—å°å¾„", targetScore: 100, speed: 180, obstacles: [{x: 5, y: 5}, {x: 15, y: 15}] },
            { name: "å±±è°·æŒ‘æˆ˜", targetScore: 150, speed: 160, obstacles: [{x: 3, y: 8}, {x: 10, y: 10}, {x: 16, y: 5}, {x: 8, y: 16}] },
            { name: "å±é™©å³¡è°·", targetScore: 200, speed: 140, obstacles: [{x: 2, y: 2}, {x: 17, y: 2}, {x: 2, y: 17}, {x: 17, y: 17}, {x: 10, y: 8}, {x: 8, y: 12}] },
            { name: "ç»ˆæè¯•ç‚¼", targetScore: 250, speed: 120, obstacles: [{x: 1, y: 1}, {x: 18, y: 1}, {x: 1, y: 18}, {x: 18, y: 18}, {x: 9, y: 5}, {x: 11, y: 5}, {x: 5, y: 9}, {x: 15, y: 9}, {x: 9, y: 15}, {x: 11, y: 15}] }
        ];
        
        // æ¸¸æˆçŠ¶æ€
        let currentLevel = 0;
        let snake = [{x: 10, y: 10}];
        let food = {x: 5, y: 5};
        let house = null;
        let dx = 0;
        let dy = 0;
        let score = 0;
        let gameRunning = false;
        let gamePaused = false;
        let canSpawnHouse = false;
        let gameLoopId = null;
        let startTime = 0;
        let gameTime = 0;
        let timerInterval = null;
        
        // è§¦æ‘¸æ§åˆ¶å˜é‡
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        
        // è¿›åº¦ç®¡ç†
        let gameProgress = {
            unlockedLevels: 1,
            completedLevels: [],
            levelStars: {} // å­˜å‚¨æ¯ä¸ªå…³å¡çš„æ˜Ÿçº§
        };
        
        // è°ƒè¯•å‡½æ•°
        function updateDebug(message) {
            if (debugInfo) {
                debugInfo.textContent = 'çŠ¶æ€: ' + message;
            }
            console.log('æ¸¸æˆçŠ¶æ€:', message);
        }
        
        // è¿›åº¦ä¿å­˜å’ŒåŠ è½½
        function saveProgress() {
            localStorage.setItem('snakeGameProgress', JSON.stringify(gameProgress));
        }
        
        function loadProgress() {
            const saved = localStorage.getItem('snakeGameProgress');
            if (saved) {
                gameProgress = JSON.parse(saved);
                // ç¡®ä¿levelStarså±æ€§å­˜åœ¨
                if (!gameProgress.levelStars) {
                    gameProgress.levelStars = {};
                }
            }
            updateProgressDisplay();
        }
        
        function updateProgressDisplay() {
            const unlockedElement = document.getElementById('unlockedLevels');
            if (unlockedElement) {
                unlockedElement.textContent = gameProgress.unlockedLevels;
            }
        }
        
        function resetProgress() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¿›åº¦å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è§£é”çš„å…³å¡ã€‚')) {
                gameProgress = {
                    unlockedLevels: 1,
                    completedLevels: [],
                    levelStars: {}
                };
                saveProgress();
                updateProgressDisplay();
                generateLevelGrid();
                alert('è¿›åº¦å·²é‡ç½®ï¼');
            }
        }
        
        // ç•Œé¢åˆ‡æ¢
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        function showMainMenu() {
            showScreen('mainMenu');
            updateProgressDisplay();
        }
        
        function showLevelSelect() {
            showScreen('levelSelect');
            generateLevelGrid();
        }
        
        function showGameScreen(levelIndex = 0) {
            currentLevel = levelIndex;
            showScreen('gameScreen');
            updateLevelDisplay();
            initGame();
        }
        
        // ç”Ÿæˆå…³å¡é€‰æ‹©ç½‘æ ¼
        function generateLevelGrid() {
            const grid = document.getElementById('levelGrid');
            grid.innerHTML = '';
            
            levels.forEach((level, index) => {
                const card = document.createElement('div');
                card.className = 'level-card';
                
                const isUnlocked = index < gameProgress.unlockedLevels;
                const isCompleted = gameProgress.completedLevels.includes(index);
                
                if (!isUnlocked) {
                    card.classList.add('locked');
                } else if (isCompleted) {
                    card.classList.add('completed');
                }
                
                card.innerHTML = `
                    <div class="level-number">${index + 1}</div>
                    <div class="level-name">${level.name}</div>
                    <div class="level-status">ç›®æ ‡: ${level.targetScore}åˆ†</div>
                    ${!isUnlocked ? '<div class="lock-icon">ğŸ”’</div>' : ''}
                    ${isCompleted ? `<div class="star-rating">${'â­'.repeat(gameProgress.levelStars[index] || 0)}</div>` : ''}
                `;
                
                if (isUnlocked) {
                    card.addEventListener('click', () => {
                        showGameScreen(index);
                    });
                    card.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        showGameScreen(index);
                    });
                }
                
                grid.appendChild(card);
            });
        }
        
        // å¿«é€Ÿå¼€å§‹ï¼ˆä»å½“å‰æœ€é«˜è§£é”å…³å¡å¼€å§‹ï¼‰
        function startQuickGame() {
            const lastUnlocked = Math.max(0, gameProgress.unlockedLevels - 1);
            showGameScreen(lastUnlocked);
        }
        
        // ç§»åŠ¨ç«¯æ–¹å‘æ§åˆ¶
        function changeDirection(direction) {
            if (!gameRunning || gamePaused) return;
            
            switch(direction) {
                case 'up':
                    if (dy !== 1) { dx = 0; dy = -1; }
                    break;
                case 'down':
                    if (dy !== -1) { dx = 0; dy = 1; }
                    break;
                case 'left':
                    if (dx !== 1) { dx = -1; dy = 0; }
                    break;
                case 'right':
                    if (dx !== -1) { dx = 1; dy = 0; }
                    break;
            }
        }
        
        // è§¦æ‘¸æ»‘åŠ¨æ§åˆ¶
        function setupTouchControls() {
            if (canvas) {
                canvas.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    touchStartX = touch.clientX;
                    touchStartY = touch.clientY;
                }, { passive: false });
                
                canvas.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    if (!gameRunning || gamePaused) return;
                    
                    const touch = e.changedTouches[0];
                    touchEndX = touch.clientX;
                    touchEndY = touch.clientY;
                    
                    const deltaX = touchEndX - touchStartX;
                    const deltaY = touchEndY - touchStartY;
                    const minSwipeDistance = 30;
                    
                    if (Math.abs(deltaX) > Math.abs(deltaY)) {
                        // æ°´å¹³æ»‘åŠ¨
                        if (Math.abs(deltaX) > minSwipeDistance) {
                            if (deltaX > 0) {
                                changeDirection('right');
                            } else {
                                changeDirection('left');
                            }
                        }
                    } else {
                        // å‚ç›´æ»‘åŠ¨
                        if (Math.abs(deltaY) > minSwipeDistance) {
                            if (deltaY > 0) {
                                changeDirection('down');
                            } else {
                                changeDirection('up');
                            }
                        }
                    }
                }, { passive: false });
            }
        }
        
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('å…¨å±€é”™è¯¯:', e.error);
            updateDebug('é”™è¯¯: ' + e.message);
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadProgress();
            initGame();
            setupTouchControls();
        });
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
    try {
        updateDebug('åˆå§‹åŒ–ä¸­...');
        
        // è·å–DOMå…ƒç´ 
        canvas = document.getElementById('gameCanvas');
        ctx = canvas.getContext('2d');
        scoreElement = document.getElementById('score');
        gameOverElement = document.getElementById('gameOver');
        levelCompleteElement = document.getElementById('levelComplete');
        finalScoreElement = document.getElementById('finalScore');
        currentLevelElement = document.getElementById('currentLevel');
        levelNameElement = document.getElementById('levelName');
        targetScoreElement = document.getElementById('targetScore');
        houseHintElement = document.getElementById('houseHint');
        debugInfo = document.getElementById('debugInfo');
        timerElement = document.getElementById('timer'); // æ·»åŠ è¿™ä¸€è¡Œ
        
        if (!canvas || !ctx) {
            throw new Error('æ— æ³•è·å–Canvaså…ƒç´ ');
        }
        
        tileCount = canvas.width / gridSize;
        
        // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
        updateLevelDisplay();
        generateFood();
        drawGame();
        
        updateDebug('åˆå§‹åŒ–å®Œæˆ');
        
    } catch (error) {
        console.error('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
        updateDebug('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
    }
        }
        
        // ... å…¶ä½™å‡½æ•°ä¿æŒä¸å˜ ...
        // æ›´æ–°å…³å¡ä¿¡æ¯æ˜¾ç¤º
        function updateLevelDisplay() {
            try {
                const level = levels[currentLevel];
                if (currentLevelElement) currentLevelElement.textContent = currentLevel + 1;
                if (levelNameElement) levelNameElement.textContent = level.name;
                if (targetScoreElement) targetScoreElement.textContent = level.targetScore;
            } catch (error) {
                console.error('æ›´æ–°å…³å¡æ˜¾ç¤ºå¤±è´¥:', error);
            }
        }
        
        // ç”Ÿæˆéšæœºé£Ÿç‰©ä½ç½®ï¼ˆé¿å…è§’è½å’Œé‡å¤ä½ç½®ï¼‰
        function generateFood() {
            try {
                let attempts = 0;
                let newFood;
                do {
                    // é¿å…åœ¨è¾¹ç¼˜2æ ¼å†…ç”Ÿæˆé£Ÿç‰©
                    newFood = {
                        x: Math.floor(Math.random() * (tileCount - 4)) + 2,
                        y: Math.floor(Math.random() * (tileCount - 4)) + 2
                    };
                    attempts++;
                } while ((isPositionOccupied(newFood.x, newFood.y, true) || 
                         (food && newFood.x === food.x && newFood.y === food.y)) && 
                         attempts < 100);
                
                if (attempts >= 100) {
                    // å¯»æ‰¾ä¸€ä¸ªå®‰å…¨çš„å¤‡ç”¨ä½ç½®
                    for (let x = 2; x < tileCount - 2; x++) {
                        for (let y = 2; y < tileCount - 2; y++) {
                            if (!isPositionOccupied(x, y, true) && 
                                !(food && x === food.x && y === food.y)) {
                                newFood = {x: x, y: y};
                                break;
                            }
                        }
                        if (newFood) break;
                    }
                    if (!newFood) {
                        newFood = {x: 5, y: 5}; // æœ€åçš„å¤‡ç”¨ä½ç½®
                    }
                }
                
                food = newFood;
                console.log('ç”Ÿæˆæ–°é£Ÿç‰©ä½ç½®:', food);
                
            } catch (error) {
                console.error('ç”Ÿæˆé£Ÿç‰©å¤±è´¥:', error);
                food = {x: 5, y: 5}; // é»˜è®¤ä½ç½®
            }
        }
        
        // ç”Ÿæˆæˆ¿å­ï¼ˆé¿å…è§’è½ï¼‰
        function generateHouse() {
            try {
                if (!canSpawnHouse) return;
                
                let attempts = 0;
                do {
                    // é¿å…åœ¨è¾¹ç¼˜2æ ¼å†…ç”Ÿæˆæˆ¿å­
                    house = {
                        x: Math.floor(Math.random() * (tileCount - 4)) + 2,
                        y: Math.floor(Math.random() * (tileCount - 4)) + 2
                    };
                    attempts++;
                } while (isPositionOccupied(house.x, house.y) && attempts < 100);
                
                if (attempts >= 100) {
                    house = {x: 3, y: 3}; // å¤‡ç”¨ä½ç½®
                }
                
                if (houseHintElement) {
                    houseHintElement.style.display = 'block';
                }
            } catch (error) {
                console.error('ç”Ÿæˆæˆ¿å­å¤±è´¥:', error);
            }
        }
        
        // æ£€æŸ¥ä½ç½®æ˜¯å¦è¢«å ç”¨
        function isPositionOccupied(x, y, excludeCurrentFood = false) {
            try {
                // æ£€æŸ¥è›‡èº«
                for (let segment of snake) {
                    if (segment.x === x && segment.y === y) return true;
                }
                
                // æ£€æŸ¥éšœç¢ç‰©
                const level = levels[currentLevel];
                if (level && level.obstacles) {
                    for (let obstacle of level.obstacles) {
                        if (obstacle.x === x && obstacle.y === y) return true;
                    }
                }
                
                // æ£€æŸ¥é£Ÿç‰©ï¼ˆå¯é€‰æ‹©æ’é™¤å½“å‰é£Ÿç‰©ä½ç½®ï¼‰
                if (!excludeCurrentFood && food && food.x === x && food.y === y) return true;
                
                // æ£€æŸ¥æˆ¿å­
                if (house && house.x === x && house.y === y) return true;
                
                return false;
            } catch (error) {
                console.error('æ£€æŸ¥ä½ç½®å ç”¨å¤±è´¥:', error);
                return false;
            }
        }
        
        // ç»˜åˆ¶æ¸¸æˆå…ƒç´ 
        function drawGame() {
            try {
                if (!ctx || !canvas) return;
                
                // æ¸…ç©ºç”»å¸ƒ
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶éšœç¢ç‰© - å¤§ä¾¿emoji
                const level = levels[currentLevel];
                if (level && level.obstacles) {
                    ctx.font = `${gridSize-2}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    for (let obstacle of level.obstacles) {
                        ctx.fillText('ğŸ’©', 
                            obstacle.x * gridSize + gridSize/2, 
                            obstacle.y * gridSize + gridSize/2
                        );
                    }
                }
                
                // ç»˜åˆ¶è›‡èº«ï¼ˆé™¤äº†å¤´éƒ¨å’Œå°¾å·´ï¼‰
                if (snake.length > 1) {
                    for (let i = 1; i < snake.length - 1; i++) {
                        const segment = snake[i];
                        // ç°è‰²è›‡èº«
                        ctx.fillStyle = '#808080';
                        ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
                        
                        // æ·»åŠ é»‘è‰²æ–‘ç‚¹
                        ctx.fillStyle = '#000000';
                        ctx.beginPath();
                        ctx.arc(segment.x * gridSize + gridSize/3, segment.y * gridSize + gridSize/3, 1, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(segment.x * gridSize + 2*gridSize/3, segment.y * gridSize + 2*gridSize/3, 1, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                }
                
                // ç»˜åˆ¶è›‡å°¾ï¼ˆæœ€åä¸€ä¸ªåƒç´ ï¼‰- ç°è‰²ç²—çº¿
                if (snake.length > 1) {
                    const tail = snake[snake.length - 1];
                    const beforeTail = snake[snake.length - 2];
                    
                    ctx.strokeStyle = '#808080';
                    ctx.lineWidth = 4;
                    ctx.lineCap = 'round';
                    
                    // è®¡ç®—å°¾å·´æ–¹å‘
                    const tailX = tail.x * gridSize + gridSize/2;
                    const tailY = tail.y * gridSize + gridSize/2;
                    const beforeTailX = beforeTail.x * gridSize + gridSize/2;
                    const beforeTailY = beforeTail.y * gridSize + gridSize/2;
                    
                    // ç»˜åˆ¶ä»å°¾å·´ä¸­å¿ƒå‘å¤–å»¶ä¼¸çš„çº¿
                    const dx = tailX - beforeTailX;
                    const dy = tailY - beforeTailY;
                    const length = Math.sqrt(dx*dx + dy*dy);
                    const unitX = dx / length;
                    const unitY = dy / length;
                    
                    ctx.beginPath();
                    ctx.moveTo(tailX, tailY);
                    ctx.lineTo(tailX + unitX * gridSize/2, tailY + unitY * gridSize/2);
                    ctx.stroke();
                }
                
                // ç»˜åˆ¶æ¥ç¦çš„å¤´éƒ¨ - ç°è‰²åƒç´ ç‹—å¤´
                if (snake.length > 0) {
                    const head = snake[0];
                    const x = head.x * gridSize;
                    const y = head.y * gridSize;
                    
                    // ç‹—å¤´ä¸»ä½“ - ç°è‰²
                    ctx.fillStyle = '#808080';
                    ctx.fillRect(x + 2, y + 2, gridSize - 4, gridSize - 4);
                    
                    // ç‹—è€³æœµ - æ·±ç°è‰²
                    ctx.fillStyle = '#606060';
                    ctx.fillRect(x + 1, y + 1, 3, 4); // å·¦è€³
                    ctx.fillRect(x + gridSize - 4, y + 1, 3, 4); // å³è€³
                    
                    // ç‹—çœ¼ç› - é»‘è‰²
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(x + 4, y + 4, 2, 2); // å·¦çœ¼
                    ctx.fillRect(x + gridSize - 6, y + 4, 2, 2); // å³çœ¼
                    
                    // ç‹—é¼»å­ - é»‘è‰²
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(x + gridSize/2 - 1, y + 7, 2, 2);
                    
                    // ç‹—å˜´å·´ - æ·±ç°è‰²çº¿æ¡
                    ctx.fillStyle = '#404040';
                    ctx.fillRect(x + gridSize/2 - 2, y + 10, 4, 1); // å˜´å·´çº¿
                    
                    // ç‹—é¼»å­åˆ°å˜´å·´çš„è¿çº¿
                    ctx.fillRect(x + gridSize/2, y + 9, 1, 1);
                }
                
                // ç»˜åˆ¶é£Ÿç‰© - é¦™è‚ emoji
                if (food) {
                    ctx.font = `${gridSize-2}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('ğŸŒ­', 
                        food.x * gridSize + gridSize/2, 
                        food.y * gridSize + gridSize/2
                    );
                }
                
                // ç»˜åˆ¶æˆ¿å­
                if (house) {
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(house.x * gridSize, house.y * gridSize, gridSize - 2, gridSize - 2);
                    
                    // ç»˜åˆ¶æˆ¿å­å›¾æ ‡
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(house.x * gridSize + 2, house.y * gridSize + gridSize/2, gridSize - 4, gridSize/2 - 2);
                    ctx.fillStyle = '#DC143C';
                    ctx.beginPath();
                    ctx.moveTo(house.x * gridSize + 1, house.y * gridSize + gridSize/2);
                    ctx.lineTo(house.x * gridSize + gridSize/2, house.y * gridSize + 1);
                    ctx.lineTo(house.x * gridSize + gridSize - 1, house.y * gridSize + gridSize/2);
                    ctx.closePath();
                    ctx.fill();
                }
                
            } catch (error) {
                console.error('ç»˜åˆ¶æ¸¸æˆå¤±è´¥:', error);
                updateDebug('ç»˜åˆ¶é”™è¯¯: ' + error.message);
            }
        }
        
        // ç§»åŠ¨è›‡
function moveSnake() {
    try {
        if (dx === 0 && dy === 0) return;
        
        const head = {x: snake[0].x + dx, y: snake[0].y + dy};
        let gameOverReason = '';
        
        // æ£€æŸ¥è¾¹ç•Œç¢°æ’
        if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
            gameOverReason = 'æ¥ç¦æ’åˆ°äº†å¢™ï¼Œå¥½ç—›';
            gameOver(gameOverReason);
            return;
        }
        
        // æ£€æŸ¥éšœç¢ç‰©ç¢°æ’
        const level = levels[currentLevel];
        if (level && level.obstacles) {
            for (let obstacle of level.obstacles) {
                if (head.x === obstacle.x && head.y === obstacle.y) {
                    gameOverReason = 'æ¥ç¦åƒäº†å¤§ä¾¿è¢«å¦ˆå¦ˆæ‰“äº†ä¸€é¡¿';
                    gameOver(gameOverReason);
                    return;
                }
            }
        }
        
        // æ£€æŸ¥è‡ªèº«ç¢°æ’
        for (let segment of snake) {
            if (head.x === segment.x && head.y === segment.y) {
                gameOverReason = 'æ¥ç¦å’¬åˆ°äº†è‡ªå·±çš„å°¾å·´';
                gameOver(gameOverReason);
                return;
            }
        }
        
        snake.unshift(head);
        
        // æ£€æŸ¥æ˜¯å¦åƒåˆ°æˆ¿å­ï¼ˆé€šå…³ï¼‰
        if (house && head.x === house.x && head.y === house.y) {
            levelComplete();
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
        if (food && head.x === food.x && head.y === food.y && !house) {
            score += 10;
            if (scoreElement) scoreElement.textContent = score;
            
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›®æ ‡åˆ†æ•°
            if (score >= level.targetScore && !canSpawnHouse) {
                canSpawnHouse = true;
                generateHouse();
                // åœæ­¢ç”Ÿæˆé£Ÿç‰©
                food = null;
            } else if (!canSpawnHouse) {
                generateFood();
            }
        } else {
            snake.pop();
        }
        
    } catch (error) {
        console.error('ç§»åŠ¨è›‡å¤±è´¥:', error);
        gameOver('æ¸¸æˆå‡ºç°é”™è¯¯');
    }
}
        
        // æ¸¸æˆç»“æŸ
function gameOver(reason = 'æ¸¸æˆç»“æŸ') {
    try {
        gameRunning = false;
        if (gameLoopId) {
            clearTimeout(gameLoopId);
            gameLoopId = null;
        }
        // åœæ­¢è®¡æ—¶å™¨
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        // æ›´æ–°æ¸¸æˆç»“æŸç•Œé¢çš„æ ‡é¢˜
        const gameOverTitle = document.querySelector('#gameOver h2');
        if (gameOverTitle) {
            gameOverTitle.textContent = reason;
        }
        
        if (finalScoreElement) finalScoreElement.textContent = score;
        
        // æ›´æ–°æœ€ç»ˆæ—¶é—´æ˜¾ç¤º
        const finalTimeElement = document.getElementById('finalTime');
        if (finalTimeElement && timerElement) {
            finalTimeElement.textContent = timerElement.textContent;
        }
        
        if (gameOverElement) gameOverElement.style.display = 'block';
        updateDebug('æ¸¸æˆç»“æŸ: ' + reason);
    } catch (error) {
        console.error('æ¸¸æˆç»“æŸå¤„ç†å¤±è´¥:', error);
    }
}
        
        // å…³å¡å®Œæˆ
        function levelComplete() {
    try {
        gameRunning = false;
        if (gameLoopId) {
            clearTimeout(gameLoopId);
            gameLoopId = null;
        }
        // åœæ­¢è®¡æ—¶å™¨
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        // è®¡ç®—æ˜Ÿçº§è¯„å®š
        const level = levels[currentLevel];
        const targetTime = level.targetScore * 10; // 10ç§’ = 3æ˜Ÿ
        let stars = 1;
        if (gameTime <= targetTime) {
            stars = 3;
        } else if (gameTime <= targetTime * 2) {
            stars = 2;
        }
        
        // ä¿å­˜æœ€é«˜æ˜Ÿçº§
        if (!gameProgress.levelStars[currentLevel] || gameProgress.levelStars[currentLevel] < stars) {
            gameProgress.levelStars[currentLevel] = stars;
        }
        
        // æ›´æ–°è¿›åº¦
        if (!gameProgress.completedLevels.includes(currentLevel)) {
            gameProgress.completedLevels.push(currentLevel);
        }
        
        // è§£é”ä¸‹ä¸€å…³
        const nextLevelIndex = currentLevel + 1;
        let isNewUnlock = false;
        if (nextLevelIndex < levels.length && gameProgress.unlockedLevels <= nextLevelIndex) {
            gameProgress.unlockedLevels = nextLevelIndex + 1;
            isNewUnlock = true;
        }
        
        saveProgress();
        
        // æ˜¾ç¤ºå®Œæˆç•Œé¢
        const completedLevelElement = document.getElementById('completedLevel');
        const levelScoreElement = document.getElementById('levelScore');
        const unlockMessage = document.getElementById('unlockMessage');
        const starsElement = document.getElementById('levelStars');
        
        if (completedLevelElement) completedLevelElement.textContent = levels[currentLevel].name;
        if (levelScoreElement) levelScoreElement.textContent = score;
        
        // æ›´æ–°å®Œæˆæ—¶é—´æ˜¾ç¤º
        const completionTimeElement = document.getElementById('completionTime');
        if (completionTimeElement && timerElement) {
            completionTimeElement.textContent = timerElement.textContent;
        }
        
        if (unlockMessage) {
            unlockMessage.style.display = isNewUnlock ? 'block' : 'none';
        }
        if (starsElement) {
            starsElement.textContent = 'â˜…'.repeat(stars) + 'â˜†'.repeat(3 - stars);
        }
        if (levelCompleteElement) levelCompleteElement.style.display = 'block';
        
        updateDebug('å…³å¡å®Œæˆ');
    } catch (error) {
        console.error('å…³å¡å®Œæˆå¤„ç†å¤±è´¥:', error);
    }
        }
        
        // ä¸‹ä¸€å…³
        function nextLevel() {
            try {
                if (currentLevel < levels.length - 1) {
                    currentLevel++;
                    if (levelCompleteElement) levelCompleteElement.style.display = 'none';
                    resetLevel();
                } else {
                    alert('ğŸ‰ æ­å–œæ‚¨å®Œæˆäº†æ‰€æœ‰å…³å¡ï¼æ¥ç¦æˆåŠŸå›åˆ°äº†å®¶ï¼');
                    showMainMenu();
                }
            } catch (error) {
                console.error('ä¸‹ä¸€å…³å¤±è´¥:', error);
            }
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            try {
                if (!gameRunning || gamePaused) return;
                
                moveSnake();
                drawGame();
                
                if (gameRunning) {
                    const level = levels[currentLevel];
                    gameLoopId = setTimeout(gameLoop, level.speed);
                }
            } catch (error) {
                console.error('æ¸¸æˆå¾ªç¯é”™è¯¯:', error);
                updateDebug('å¾ªç¯é”™è¯¯: ' + error.message);
                gameOver();
            }
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame() {
    try {
        updateDebug('å¼€å§‹æ¸¸æˆ...');
        
        if (gameRunning) return;
        
        // æ¸…é™¤ä¹‹å‰çš„å¾ªç¯å’Œè®¡æ—¶å™¨
        if (gameLoopId) {
            clearTimeout(gameLoopId);
            gameLoopId = null;
        }
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        // é‡ç½®æ¸¸æˆçŠ¶æ€
        snake = [{x: 10, y: 10}];
        dx = 1;
        dy = 0;
        score = 0;
        if (scoreElement) scoreElement.textContent = score;
        gameRunning = true;
        gamePaused = false;
        canSpawnHouse = false;
        house = null;
        
        // é‡ç½®å¹¶å¯åŠ¨è®¡æ—¶å™¨
        startTime = Date.now();
        gameTime = 0;
        if (timerElement) timerElement.textContent = '00:00';
        timerInterval = setInterval(updateTimer, 1000);
        
        // éšè—å¼¹çª—
        if (gameOverElement) gameOverElement.style.display = 'none';
        if (levelCompleteElement) levelCompleteElement.style.display = 'none';
        if (houseHintElement) houseHintElement.style.display = 'none';
        
        generateFood();
        drawGame();
        
        updateDebug('æ¸¸æˆè¿è¡Œä¸­');
        gameLoop();
        
    } catch (error) {
        console.error('å¼€å§‹æ¸¸æˆå¤±è´¥:', error);
        updateDebug('å¼€å§‹å¤±è´¥: ' + error.message);
    }
        }
        
        // é‡ç½®å…³å¡
        function resetLevel() {
            try {
                gameRunning = false;
                if (gameLoopId) {
                    clearTimeout(gameLoopId);
                    gameLoopId = null;
                }
                updateLevelDisplay();
                startGame();
            } catch (error) {
                console.error('é‡ç½®å…³å¡å¤±è´¥:', error);
            }
        }
        
        // æš‚åœæ¸¸æˆ
        function pauseGame() {
    try {
        if (!gameRunning) return;
        gamePaused = !gamePaused;
        
        if (gamePaused) {
            // æš‚åœæ—¶åœæ­¢è®¡æ—¶å™¨
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        } else {
            // ç»§ç»­æ—¶é‡æ–°å¯åŠ¨è®¡æ—¶å™¨
            startTime = Date.now() - (gameTime * 1000);
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        updateDebug(gamePaused ? 'æ¸¸æˆæš‚åœ' : 'æ¸¸æˆç»§ç»­');
        if (!gamePaused) {
            gameLoop();
        }
    } catch (error) {
        console.error('æš‚åœæ¸¸æˆå¤±è´¥:', error);
    }
        }
        
        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', function(e) {
            try {
                if (!gameRunning || gamePaused) return;
                
                switch(e.key) {
                    case 'ArrowUp':
                        if (dy !== 1) { dx = 0; dy = -1; }
                        break;
                    case 'ArrowDown':
                        if (dy !== -1) { dx = 0; dy = 1; }
                        break;
                    case 'ArrowLeft':
                        if (dx !== 1) { dx = -1; dy = 0; }
                        break;
                    case 'ArrowRight':
                        if (dx !== -1) { dx = 1; dy = 0; }
                        break;
                    case ' ':
                        e.preventDefault();
                        pauseGame();
                        break;
                }
            } catch (error) {
                console.error('é”®ç›˜æ§åˆ¶å¤±è´¥:', error);
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('load', function() {
            try {
                initGame();
            } catch (error) {
                console.error('é¡µé¢åŠ è½½åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });
        
        // ä»æ¸¸æˆç»“æŸç•Œé¢è·³è½¬åˆ°å…³å¡é€‰æ‹©
        function gameOverToLevelSelect() {
            try {
                if (gameOverElement) gameOverElement.style.display = 'none';
                showLevelSelect();
            } catch (error) {
                console.error('è·³è½¬åˆ°å…³å¡é€‰æ‹©å¤±è´¥:', error);
            }
        }
        
        // ä»å…³å¡å®Œæˆç•Œé¢è·³è½¬åˆ°å…³å¡é€‰æ‹©
        function levelCompleteToLevelSelect() {
            try {
                if (levelCompleteElement) levelCompleteElement.style.display = 'none';
                showLevelSelect();
            } catch (error) {
                console.error('è·³è½¬åˆ°å…³å¡é€‰æ‹©å¤±è´¥:', error);
            }
        }
        
        // æ·»åŠ æ›´æ–°è®¡æ—¶å™¨å‡½æ•°
function updateTimer() {
    if (timerElement && gameRunning && !gamePaused) {
        gameTime = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(gameTime / 60);
        const seconds = gameTime % 60;
        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

// å…¨å±€é”™è¯¯å¤„ç†
window.addEventListener('error', function(e) {
    console.error('å…¨å±€é”™è¯¯:', e.error);
    updateDebug('å‘ç”Ÿé”™è¯¯: ' + e.message);
});
    </script>
</body>
</html>