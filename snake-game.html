<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêï Êù•Á¶èÁãóË¥™ÂêÉÂ§ß‰ΩúÊàò</title>

    <!-- PWAÊîØÊåÅ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8B7EC8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Êù•Á¶èË¥™ÂêÉËõá">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
jishi        }

        /* Ë£ÖÈ•∞ÂõæÁâáÊ†∑Âºè */
        .decoration-dog {
pen'guonguo            position: absolute;
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            opacity: 0.8;
            z-index: 1;
            pointer-events: none;
            transition: opacity 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .decoration-dog:hover {
            opacity: 1;
        }
        
        /* ‰∏ªËèúÂçïË£ÖÈ•∞ - Â∑¶Ëæπ3Âº†Âè≥Ëæπ3Âº† */
        .main-menu-decoration {
            position: absolute;
        }
        
        .dog1 {
            top: 20px;
            left: 20px;
            width: 80px;
            height: 60px;
        }
        
        .dog2 {
            top: 20px;
            right: 20px;
            width: 80px;
            height: 60px;
        }
        
        .dog4 {
            top: 100px;
            left: 20px;
            width: 80px;
            height: 60px;
        }
        
        .dog5 {
            top: 100px;
            right: 20px;
            width: 80px;
            height: 60px;
        }
        
        .dog6 {
            top: 180px;
            left: 20px;
            width: 80px;
            height: 60px;
        }
        
        .dog7 {
            top: 180px;
            right: 20px;
            width: 80px;
            height: 60px;
        }
        
        /* ÂÖ≥Âç°ÈÄâÊã©Ë£ÖÈ•∞ - Â∑¶Ëæπ3Âº†Âè≥Ëæπ3Âº† */
        .level-decoration {
            position: absolute;
        }
        
        .level-dog1 {
            top: 15px;
            left: 15px;
            width: 75px;
            height: 55px;
        }
        
        .level-dog2 {
            top: 15px;
            right: 15px;
            width: 75px;
            height: 55px;
        }
        
        .level-dog4 {
            top: 90px;
            left: 15px;
            width: 75px;
            height: 55px;
        }
        
        .level-dog5 {
            top: 90px;
            right: 15px;
            width: 75px;
            height: 55px;
        }
        
        .level-dog6 {
            top: 165px;
            left: 15px;
            width: 75px;
            height: 55px;
        }
        
        .level-dog7 {
            top: 165px;
            right: 15px;
            width: 75px;
            height: 55px;
        }
        
        /* Ê∏∏ÊàèÁïåÈù¢Ë£ÖÈ•∞ - Â∑¶Ëæπ3Âº†Âè≥Ëæπ3Âº† */
        .game-decoration {
            position: absolute;
        }
        
        .game-dog1 {
            top: 10px;
            left: 10px;
            width: 70px;
            height: 50px;
        }
        
        .game-dog2 {
            top: 10px;
            right: 10px;
            width: 70px;
            height: 50px;
        }
        
        .game-dog4 {
            top: 80px;
            left: 10px;
            width: 70px;
            height: 50px;
        }
        
        .game-dog5 {
            top: 80px;
            right: 10px;
            width: 70px;
            height: 50px;
        }
        
        .game-dog6 {
            top: 150px;
            left: 10px;
            width: 70px;
            height: 50px;
        }
        
        .game-dog7 {
            top: 150px;
            right: 10px;
            width: 70px;
            height: 50px;
        }
        
        /* ÁßªÂä®Á´ØÈÄÇÈÖç */
        @media (max-width: 768px) {
            .decoration-dog {
                width: 50px;
                height: 38px;
            }
            
            .dog1, .dog2, .dog4, .dog5, .dog6, .dog7 {
                width: 50px;
                height: 38px;
            }
            
            .dog4 { top: 80px; }
            .dog5 { top: 80px; }
            .dog6 { top: 140px; }
            .dog7 { top: 140px; }
            
            .game-dog1, .game-dog2, .game-dog4, .game-dog5, .game-dog6, .game-dog7 {
                width: 45px;
                height: 35px;
            }
            
            .game-dog4 { top: 65px; }
            .game-dog5 { top: 65px; }
            .game-dog6 { top: 120px; }
            .game-dog7 { top: 120px; }
            
            .level-dog1, .level-dog2, .level-dog4, .level-dog5, .level-dog6, .level-dog7 {
                width: 48px;
                height: 36px;
            }
            
            .level-dog4 { top: 70px; }
            .level-dog5 { top: 70px; }
            .level-dog6 { top: 125px; }
            .level-dog7 { top: 125px; }
        }
        
        .game-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* ‰∏ªËèúÂçïÊ†∑Âºè */
        .main-menu {
            color: white;
        }
        
        .main-menu h2 {
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        /* ÂÖ≥Âç°ÈÄâÊã©ÁïåÈù¢Ê†∑Âºè */
        .level-select {
            color: white;
        }
        
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .level-card {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .level-card:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .level-card.locked {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .level-card.completed {
            background: rgba(0, 255, 0, 0.2);
            border-color: rgba(0, 255, 0, 0.5);
        }
        
        .level-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .level-name {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .level-status {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .lock-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
        }
        
        .star-rating {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
            color: #FFD700;
        }
        
        /* Ê∏∏ÊàèÁïåÈù¢Ê†∑Âºè */
        .game-screen {
            color: white;
        }
        
        .level-info {
            color: white;
            font-size: 18px;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .score {
            color: white;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .target-score {
            color: #FFD700;
            font-size: 16px;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .timer {
            color: #FF6B6B;
            font-size: 18px;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        #gameCanvas {
            border: 3px solid white;
            border-radius: 10px;
            background: #2c3e50;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            max-width: 100%;
            height: auto;
        }
        
        /* ÁßªÂä®Á´ØÊéßÂà∂ÊåâÈíÆ */
        .mobile-controls {
            display: none;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .mobile-controls {
                display: block;
            }
        }
        
        .direction-pad {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 5px;
            max-width: 150px;
            margin: 0 auto 15px;
        }
        
        .direction-btn {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            border-radius: 10px;
            color: white;
            font-size: 20px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            touch-action: manipulation;
        }
        
        .direction-btn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.95);
        }
        
        .direction-btn.up {
            grid-column: 2;
            grid-row: 1;
        }
        
        .direction-btn.left {
            grid-column: 1;
            grid-row: 2;
        }
        
        .direction-btn.right {
            grid-column: 3;
            grid-row: 2;
        }
        
        .direction-btn.down {
            grid-column: 2;
            grid-row: 3;
        }
        
        .controls {
            margin-top: 15px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: clamp(12px, 3vw, 16px);
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .btn:hover, .btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .btn.primary {
            background: rgba(0, 123, 255, 0.6);
            border-color: #007bff;
        }
        
        .btn.primary:hover, .btn.primary:active {
            background: rgba(0, 123, 255, 0.8);
        }
        
        .game-over, .level-complete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 1000;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .level-complete {
            background: rgba(0, 128, 0, 0.9);
        }
        
        .house-hint {
            color: #FFD700;
            font-size: clamp(12px, 3vw, 14px);
            margin-top: 8px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        
        .debug {
            color: #ccc;
            font-size: clamp(10px, 2.5vw, 12px);
            margin-top: 8px;
        }
        
        .progress-info {
            color: #FFD700;
            font-size: clamp(12px, 3vw, 14px);
            margin-bottom: 15px;
        }
        
        .star-display {
            font-size: 24px;
            margin: 10px 0;
        }
        
        .time-display {
            color: #FFD700;
            font-size: 16px;
            margin: 5px 0;
        }
        
        /* Ëß¶Êë∏ÊªëÂä®ÊéßÂà∂ÊèêÁ§∫ */
        .touch-hint {
            color: rgba(255, 255, 255, 0.7);
            font-size: clamp(10px, 2.5vw, 12px);
            margin-top: 5px;
        }
        
        @media (min-width: 769px) {
            .touch-hint {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üêï Êù•Á¶èÁãóË¥™ÂêÉÂ§ß‰ΩúÊàò</h1>
        
        <!-- ‰∏ªËèúÂçï -->
        <div id="mainMenu" class="screen main-menu active">
            <!-- Ë£ÖÈ•∞ÂõæÁâá -->
            <img src="dog1.jpg.jpg" alt="" class="decoration-dog main-menu-decoration dog1">
            <img src="dog2.jpg.png" alt="" class="decoration-dog main-menu-decoration dog2">
            <img src="dog4.jpg.jpg" alt="" class="decoration-dog main-menu-decoration dog4">
            <img src="dog5.jpg.jpg" alt="" class="decoration-dog main-menu-decoration dog5">
            <img src="dog6.jpg.jpg" alt="" class="decoration-dog main-menu-decoration dog6">
            <img src="dog7.jpg.jpg" alt="" class="decoration-dog main-menu-decoration dog7">
            
            <h2>Ê¨¢ËøéÊù•Âà∞Êù•Á¶èÁöÑÂÜíÈô©‰πãÊóÖÔºÅ</h2>
            <div class="progress-info">
                Â∑≤Ëß£ÈîÅÂÖ≥Âç°: <span id="unlockedLevels">1</span> / 5
            </div>
            <button class="btn primary" onclick="showLevelSelect()">ÈÄâÊã©ÂÖ≥Âç°</button>
            <button class="btn" onclick="startQuickGame()">Âø´ÈÄüÂºÄÂßã</button>
            <button class="btn" onclick="resetProgress()">ÈáçÁΩÆËøõÂ∫¶</button>
        </div>
        
        <!-- ÂÖ≥Âç°ÈÄâÊã©ÁïåÈù¢ -->
        <div id="levelSelect" class="screen level-select">
            <!-- Ë£ÖÈ•∞ÂõæÁâá -->
            <img src="dog1.jpg.jpg" alt="" class="decoration-dog level-decoration level-dog1">
            <img src="dog2.jpg.png" alt="" class="decoration-dog level-decoration level-dog2">
            <img src="dog4.jpg.jpg" alt="" class="decoration-dog level-decoration level-dog4">
            <img src="dog5.jpg.jpg" alt="" class="decoration-dog level-decoration level-dog5">
            <img src="dog6.jpg.jpg" alt="" class="decoration-dog level-decoration level-dog6">
            <img src="dog7.jpg.jpg" alt="" class="decoration-dog level-decoration level-dog7">
            
            <h2>ÈÄâÊã©ÂÖ≥Âç°</h2>
            <div class="level-grid" id="levelGrid">
                <!-- ÂÖ≥Âç°Âç°ÁâáÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
            </div>
            <button class="btn" onclick="showMainMenu()">ËøîÂõû‰∏ªËèúÂçï</button>
        </div>
        
        <!-- Ê∏∏ÊàèÁïåÈù¢ -->
        <div id="gameScreen" class="screen game-screen">
            <!-- Ë£ÖÈ•∞ÂõæÁâá -->
            <img src="dog1.jpg.jpg" alt="" class="decoration-dog game-decoration game-dog1">
            <img src="dog2.jpg.png" alt="" class="decoration-dog game-decoration game-dog2">
            <img src="dog4.jpg.jpg" alt="" class="decoration-dog game-decoration game-dog4">
            <img src="dog5.jpg.jpg" alt="" class="decoration-dog game-decoration game-dog5">
            <img src="dog6.jpg.jpg" alt="" class="decoration-dog game-decoration game-dog6">
            <img src="dog7.jpg.jpg" alt="" class="decoration-dog game-decoration game-dog7">
            
            <div class="level-info">ÂÖ≥Âç° <span id="currentLevel">1</span> - <span id="levelName">Êñ∞ÊâãÊùë</span></div>
            <div class="target-score">ÁõÆÊ†áÂàÜÊï∞: <span id="targetScore">50</span></div>
            <div class="score">ÂæóÂàÜ: <span id="score">0</span></div>
            <div class="timer">Êó∂Èó¥: <span id="timer">00:00</span></div>
            <div id="houseHint" class="house-hint" style="display: none;">üè† ÊâæÂà∞ÂÆ∂Âπ∂ÂêÉÊéâÂÆÉÈÄöÂÖ≥ÔºÅ</div>
            <div id="debugInfo" class="debug">Áä∂ÊÄÅ: ÂáÜÂ§áÂ∞±Áª™</div>
            <canvas id="gameCanvas" width="320" height="320"></canvas>
            
            <!-- ÁßªÂä®Á´ØÊéßÂà∂ÊåâÈíÆ -->
            <div class="mobile-controls">
                <div class="direction-pad">
                    <button class="direction-btn up" ontouchstart="changeDirection('up')" onclick="changeDirection('up')">‚Üë</button>
                    <button class="direction-btn left" ontouchstart="changeDirection('left')" onclick="changeDirection('left')">‚Üê</button>
                    <button class="direction-btn right" ontouchstart="changeDirection('right')" onclick="changeDirection('right')">‚Üí</button>
                    <button class="direction-btn down" ontouchstart="changeDirection('down')" onclick="changeDirection('down')">‚Üì</button>
                </div>
                <div class="touch-hint">‰πüÂèØ‰ª•Âú®Ê∏∏ÊàèÂå∫ÂüüÊªëÂä®ÊéßÂà∂ÊñπÂêë</div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="startGame()">ÂºÄÂßãÊ∏∏Êàè</button>
                <button class="btn" onclick="pauseGame()">ÊöÇÂÅú/ÁªßÁª≠</button>
                <button class="btn" onclick="showLevelSelect()">ÈÄâÊã©ÂÖ≥Âç°</button>
                <button class="btn" onclick="showMainMenu()">‰∏ªËèúÂçï</button>
            </div>
        </div>
        
        <div class="game-over" id="gameOver">
            <h2>Ê∏∏ÊàèÁªìÊùü!</h2>
            <p>ÊúÄÁªàÂæóÂàÜ: <span id="finalScore">0</span></p>
            <div class="time-display">Áî®Êó∂: <span id="finalTime">00:00</span></div>
            <button class="btn" onclick="startGame()">ÈáçÊñ∞ÂºÄÂßã</button>
            <button class="btn" onclick="gameOverToLevelSelect()">ÈÄâÊã©ÂÖ≥Âç°</button>
        </div>
        
        <div class="level-complete" id="levelComplete">
            <h2>üéâ ÂÖ≥Âç°ÂÆåÊàê!</h2>
            <p>ÊÅ≠ÂñúÈÄöËøá <span id="completedLevel"></span>!</p>
            <p>ÂæóÂàÜ: <span id="levelScore">0</span></p>
            <div class="time-display">Áî®Êó∂: <span id="completionTime">00:00</span></div>
            <div class="star-display" id="starDisplay">‚≠ê‚≠ê‚≠ê</div>
            <div id="unlockMessage" style="display: none;">
                <p style="color: #FFD700;">üéä Ëß£ÈîÅÊñ∞ÂÖ≥Âç°ÔºÅ</p>
            </div>
            <button class="btn" onclick="nextLevel()">‰∏ã‰∏ÄÂÖ≥</button>
            <button class="btn" onclick="startGame()">ÈáçÁé©Êú¨ÂÖ≥</button>
            <button class="btn" onclick="levelCompleteToLevelSelect()">ÈÄâÊã©ÂÖ≥Âç°</button>
        </div>
    </div>

    <script>
// Ê≥®ÂÜåService Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('./sw.js')
            .then(function(registration) {
                console.log('SW registered: ', registration);
            })
            .catch(function(registrationError) {
                console.log('SW registration failed: ', registrationError);
            });
    });
}

        // ÂÖ®Â±ÄÂèòÈáè
let canvas, ctx, scoreElement, gameOverElement, levelCompleteElement;
let finalScoreElement, currentLevelElement, levelNameElement, targetScoreElement;
let houseHintElement, debugInfo, timerElement;
let developerMode = false;
let upKeyPressCount = 0;
let lastUpKeyTime = 0;
let manualMode = false; // ÊâãÂä®ÊéßÂà∂Ê®°Âºè

// Âä®ÊÄÅÂ§ß‰æøÊéâËêΩÁ≥ªÁªüÔºàÈöêËóèÂÖ≥Âç°‰∏ìÁî®Ôºâ
let fallingPoop = []; // ÊéâËêΩÁöÑÂ§ß‰æøÊï∞ÁªÑ
let lastPoopDropTime = 0; // ‰∏äÊ¨°ÊéâËêΩÊó∂Èó¥
let poopDropInterval = 3000; // ÊéâËêΩÈó¥ÈöîÔºà3ÁßíÔºâ
        
// Ê∏∏ÊàèÈÖçÁΩÆ
const gridSize = 16;
let tileCount = 20;

// ÂÖ≥Âç°ÈÖçÁΩÆ
        const levels = [
            { name: "Êñ∞ÊâãÊùë", targetScore: 50, speed: 200, obstacles: [] },
            { name: "Ê£ÆÊûóÊé¢Èô©", targetScore: 80, speed: 180, obstacles: [{x: 5, y: 5}, {x: 15, y: 15}] },
            { name: "ÂüéÂ∏ÇËø∑ÂÆ´", targetScore: 120, speed: 160, obstacles: [{x: 3, y: 8}, {x: 10, y: 10}, {x: 16, y: 5}] },
            { name: "Âç±Èô©Â≥°Ë∞∑", targetScore: 200, speed: 140, obstacles: [{x: 2, y: 2}, {x: 17, y: 2}, {x: 2, y: 17}, {x: 17, y: 17}, {x: 10, y: 8}, {x: 8, y: 12}] },
            { name: "ÁªàÊûÅËØïÁÇº", targetScore: 250, speed: 120, obstacles: [{x: 1, y: 1}, {x: 18, y: 1}, {x: 1, y: 18}, {x: 18, y: 18}, {x: 9, y: 5}, {x: 11, y: 5}, {x: 5, y: 9}, {x: 15, y: 9}, {x: 9, y: 15}, {x: 11, y: 15}] },
            { name: "üë© Â¶àÂ¶àÁöÑËøΩÂáª", targetScore: 300, speed: 100, obstacles: [], isHidden: true, isInfinite: true }, // ÈöêËóèÂÖ≥Âç° - Êó†ËæπÁïåÊ®°Âºè
        ];
        
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let currentLevel = 0;
        let snake = [{x: 10, y: 10}];
        let food = {x: 5, y: 5};
        let house = null;
        let dx = 0;
        let dy = 0;
        let score = 0;
        let gameRunning = false;
        let gamePaused = false;
        let canSpawnHouse = false;
        let gameLoopId = null;
        let startTime = 0;
        let gameTime = 0;
        let timerInterval = null;
        
        
        // Â¶àÂ¶àËßíËâ≤Áõ∏ÂÖ≥ÂèòÈáèÔºàÈöêËóèÂÖ≥Âç°‰∏ìÁî®Ôºâ
        let mama = null; // Â¶àÂ¶àÁöÑ‰ΩçÁΩÆ
        let mamaDirection = {x: 0, y: 0}; // Â¶àÂ¶àÁöÑÁßªÂä®ÊñπÂêë
        let mamaLastMoveTime = 0; // Â¶àÂ¶à‰∏äÊ¨°ÁßªÂä®Êó∂Èó¥
        let mamaSpeed = 200; // Â¶àÂ¶àÁßªÂä®Èó¥ÈöîÔºàËõáÈÄüÂ∫¶ÁöÑ2ÂÄçÔºâ
        
        // Ëß¶Êë∏ÊéßÂà∂ÂèòÈáè
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        
        // ËøõÂ∫¶ÁÆ°ÁêÜ
        let gameProgress = {
            unlockedLevels: 1,
            completedLevels: [],
            levelStars: {} // Â≠òÂÇ®ÊØè‰∏™ÂÖ≥Âç°ÁöÑÊòüÁ∫ß
        };
        
        // Ë∞ÉËØïÂáΩÊï∞
        function updateDebug(message) {
            if (debugInfo) {
                debugInfo.textContent = 'Áä∂ÊÄÅ: ' + message;
            }
            console.log('Ê∏∏ÊàèÁä∂ÊÄÅ:', message);
        }
        
        // ËøõÂ∫¶‰øùÂ≠òÂíåÂä†ËΩΩ
        function saveProgress() {
            localStorage.setItem('snakeGameProgress', JSON.stringify(gameProgress));
        }
        
        function loadProgress() {
            const saved = localStorage.getItem('snakeGameProgress');
            if (saved) {
                gameProgress = JSON.parse(saved);
                // Á°Æ‰øùlevelStarsÂ±ûÊÄßÂ≠òÂú®
                if (!gameProgress.levelStars) {
                    gameProgress.levelStars = {};
                }
            }
            updateProgressDisplay();
        }
        
        function updateProgressDisplay() {
            const unlockedElement = document.getElementById('unlockedLevels');
            if (unlockedElement) {
                unlockedElement.textContent = gameProgress.unlockedLevels;
            }
        }
        
        function resetProgress() {
            if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâËøõÂ∫¶ÂêóÔºüËøôÂ∞ÜÊ∏ÖÈô§ÊâÄÊúâËß£ÈîÅÁöÑÂÖ≥Âç°„ÄÇ')) {
                gameProgress = {
                    unlockedLevels: 1,
                    completedLevels: [],
                    levelStars: {}
                };
                saveProgress();
                updateProgressDisplay();
                generateLevelGrid();
                alert('ËøõÂ∫¶Â∑≤ÈáçÁΩÆÔºÅ');
            }
        }
        
        // ÁïåÈù¢ÂàáÊç¢
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        function showMainMenu() {
            showScreen('mainMenu');
            updateProgressDisplay();
        }
        function showLevelSelect() {
            showScreen('levelSelect');
            generateLevelGrid();
            setupUnlockMode(); // Ê∑ªÂä†ËøôË°å
        }
        
        function showGameScreen(levelIndex = 0) {
            currentLevel = levelIndex;
            showScreen('gameScreen');
            updateLevelDisplay();
            initGame();
        }
        
        // ÁîüÊàêÂÖ≥Âç°ÈÄâÊã©ÁΩëÊ†º
        function generateLevelGrid() {
            const grid = document.getElementById('levelGrid');
            grid.innerHTML = '';
            
            levels.forEach((level, index) => {
                // ÈöêËóèÂÖ≥Âç°Âè™ÊúâÂú®Á¨¨‰∫îÂÖ≥ÂÆåÊàêÂêéÊâçÊòæÁ§∫
                if (level.isHidden && !gameProgress.completedLevels.includes(4)) {
                    return; // Ë∑≥ËøáÈöêËóèÂÖ≥Âç°
                }
                
                const card = document.createElement('div');
                card.className = 'level-card';
                
                const isUnlocked = index < gameProgress.unlockedLevels;
                const isCompleted = gameProgress.completedLevels.includes(index);
                
                if (!isUnlocked) {
                    card.classList.add('locked');
                } else if (isCompleted) {
                    card.classList.add('completed');
                }
                
                // ‰∏∫ÈöêËóèÂÖ≥Âç°Ê∑ªÂä†ÁâπÊÆäÊ†∑Âºè
                if (level.isHidden) {
                    card.classList.add('hidden-level');
                    card.style.background = 'linear-gradient(135deg, #FF69B4, #FF1493)';
                    card.style.border = '2px solid #FFD700';
                }
                
                card.innerHTML = `
                    <div class="level-number">${level.isHidden ? 'üë©' : index + 1}</div>
                    <div class="level-name">${level.name}</div>
                    <div class="level-status">ÁõÆÊ†á: ${level.targetScore}ÂàÜ</div>
                    ${!isUnlocked ? '<div class="lock-icon">üîí</div>' : ''}
                    ${isCompleted ? `<div class="star-rating">${'‚≠ê'.repeat(gameProgress.levelStars[index] || 0)}</div>` : ''}
                    ${level.isHidden ? '<div class="hidden-badge">ÈöêËóèÂÖ≥Âç°</div>' : ''}
                `;
                
                if (isUnlocked) {
                    card.addEventListener('click', () => {
                        showGameScreen(index);
                    });
                    card.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        showGameScreen(index);
                    });
                }
                
                grid.appendChild(card);
            });
        }
        
        // Âø´ÈÄüÂºÄÂßãÔºà‰ªéÂΩìÂâçÊúÄÈ´òËß£ÈîÅÂÖ≥Âç°ÂºÄÂßãÔºâ
        function startQuickGame() {
            const lastUnlocked = Math.max(0, gameProgress.unlockedLevels - 1);
            showGameScreen(lastUnlocked);
        }
        
        // ÁßªÂä®Á´ØÊñπÂêëÊéßÂà∂
        function changeDirection(direction) {
            if (!gameRunning || gamePaused) return;
            
            switch(direction) {
                case 'up':
                    if (dy !== 1) { dx = 0; dy = -1; }
                    break;
                case 'down':
                    if (dy !== -1) { dx = 0; dy = 1; }
                    break;
                case 'left':
                    if (dx !== 1) { dx = -1; dy = 0; }
                    break;
                case 'right':
                    if (dx !== -1) { dx = 1; dy = 0; }
                    break;
            }
        }
        
        // Ëß¶Êë∏ÊªëÂä®ÊéßÂà∂
        function setupTouchControls() {
            if (canvas) {
                // Ê∑ªÂä†ÂºÄÂèëËÄÖÊ®°ÂºèËß¶Âèë - ËøûÁª≠ÁÇπÂáªÂ±èÂπï‰∏äÊñπÂå∫Âüü3Ê¨°
                let touchCount = 0;
                let lastTouchTime = 0;
                
                canvas.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = canvas.getBoundingClientRect();
                    const y = touch.clientY - rect.top;
                    
                    // Â¶ÇÊûúÁÇπÂáªÂ±èÂπï‰∏äÊñπ1/4Âå∫Âüü
                    if (y < canvas.height / 4) {
                        const currentTime = Date.now();
                        if (currentTime - lastTouchTime < 500) {
                            touchCount++;
                        } else {
                            touchCount = 1;
                        }
                        lastTouchTime = currentTime;
                        
                        if (touchCount >= 3 && !developerMode) {
                            activateDeveloperMode();
                            return;
                        }
                    }
                    
                    touchStartX = touch.clientX;
                    touchStartY = touch.clientY;
                }, { passive: false });
                
                canvas.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    if (!gameRunning || gamePaused) return;
                    
                    const touch = e.changedTouches[0];
                    touchEndX = touch.clientX;
                    touchEndY = touch.clientY;
                    
                    const deltaX = touchEndX - touchStartX;
                    const deltaY = touchEndY - touchStartY;
                    const minSwipeDistance = 30;
                    
                    if (Math.abs(deltaX) > Math.abs(deltaY)) {
                        // Ê∞¥Âπ≥ÊªëÂä®
                        if (Math.abs(deltaX) > minSwipeDistance) {
                            if (deltaX > 0) {
                                changeDirection('right');
                            } else {
                                changeDirection('left');
                            }
                        }
                    } else {
                        // ÂûÇÁõ¥ÊªëÂä®
                        if (Math.abs(deltaY) > minSwipeDistance) {
                            if (deltaY > 0) {
                                changeDirection('down');
                            } else {
                                changeDirection('up');
                            }
                        }
                    }
                }, { passive: false });
            }
        }
        
        // ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜ
        window.addEventListener('error', function(e) {
            console.error('ÂÖ®Â±ÄÈîôËØØ:', e.error);
            updateDebug('ÈîôËØØ: ' + e.message);
        });
        

        
        // ÂàùÂßãÂåñÊ∏∏Êàè
        function initGame() {
    try {
        updateDebug('ÂàùÂßãÂåñ‰∏≠...');
        
        // Ëé∑ÂèñDOMÂÖÉÁ¥†
        canvas = document.getElementById('gameCanvas');
        ctx = canvas.getContext('2d');
        scoreElement = document.getElementById('score');
        gameOverElement = document.getElementById('gameOver');
        levelCompleteElement = document.getElementById('levelComplete');
        finalScoreElement = document.getElementById('finalScore');
        currentLevelElement = document.getElementById('currentLevel');
        levelNameElement = document.getElementById('levelName');
        targetScoreElement = document.getElementById('targetScore');
        houseHintElement = document.getElementById('houseHint');
        debugInfo = document.getElementById('debugInfo');
        timerElement = document.getElementById('timer'); // Ê∑ªÂä†Ëøô‰∏ÄË°å
        
        if (!canvas || !ctx) {
            throw new Error('Êó†Ê≥ïËé∑ÂèñCanvasÂÖÉÁ¥†');
        }
        
        tileCount = canvas.width / gridSize;
        
        // ÂàùÂßãÂåñÊ∏∏ÊàèÁä∂ÊÄÅ
        updateLevelDisplay();
        generateFood();
        initMama();
        drawGame();
        
        updateDebug('ÂàùÂßãÂåñÂÆåÊàê');
        
    } catch (error) {
        console.error('Ê∏∏ÊàèÂàùÂßãÂåñÂ§±Ë¥•:', error);
        updateDebug('ÂàùÂßãÂåñÂ§±Ë¥•: ' + error.message);
    }
        }
        
        // ... ÂÖ∂‰ΩôÂáΩÊï∞‰øùÊåÅ‰∏çÂèò ...
        // Êõ¥Êñ∞ÂÖ≥Âç°‰ø°ÊÅØÊòæÁ§∫
        function updateLevelDisplay() {
            try {
                const level = levels[currentLevel];
                if (currentLevelElement) currentLevelElement.textContent = currentLevel + 1;
                if (levelNameElement) levelNameElement.textContent = level.name;
                if (targetScoreElement) targetScoreElement.textContent = level.targetScore;
            } catch (error) {
                console.error('Êõ¥Êñ∞ÂÖ≥Âç°ÊòæÁ§∫Â§±Ë¥•:', error);
            }
        }
        
        // ÁîüÊàêÈöèÊú∫È£üÁâ©‰ΩçÁΩÆÔºàÈÅøÂÖçËßíËêΩÂíåÈáçÂ§ç‰ΩçÁΩÆÔºâ
        function generateFood() {
            try {
                let attempts = 0;
                let newFood;
                do {
                    // ÈÅøÂÖçÂú®ËæπÁºò2Ê†ºÂÜÖÁîüÊàêÈ£üÁâ©
                    newFood = {
                        x: Math.floor(Math.random() * (tileCount - 4)) + 2,
                        y: Math.floor(Math.random() * (tileCount - 4)) + 2
                    };
                    attempts++;
                } while ((isPositionOccupied(newFood.x, newFood.y, true) || 
                         (food && newFood.x === food.x && newFood.y === food.y)) && 
                         attempts < 100);
                
                if (attempts >= 100) {
                    // ÂØªÊâæ‰∏Ä‰∏™ÂÆâÂÖ®ÁöÑÂ§áÁî®‰ΩçÁΩÆ
                    for (let x = 2; x < tileCount - 2; x++) {
                        for (let y = 2; y < tileCount - 2; y++) {
                            if (!isPositionOccupied(x, y, true) && 
                                !(food && x === food.x && y === food.y)) {
                                newFood = {x: x, y: y};
                                break;
                            }
                        }
                        if (newFood) break;
                    }
                    if (!newFood) {
                        newFood = {x: 5, y: 5}; // ÊúÄÂêéÁöÑÂ§áÁî®‰ΩçÁΩÆ
                    }
                }
                
                food = newFood;
                console.log('ÁîüÊàêÊñ∞È£üÁâ©‰ΩçÁΩÆ:', food);
                
            } catch (error) {
                console.error('ÁîüÊàêÈ£üÁâ©Â§±Ë¥•:', error);
                food = {x: 5, y: 5}; // ÈªòËÆ§‰ΩçÁΩÆ
            }
        }
        
        // ÁîüÊàêÊàøÂ≠êÔºàÈÅøÂÖçËßíËêΩÔºâ
        function generateHouse() {
            try {
                if (!canSpawnHouse) return;
                
                let attempts = 0;
                do {
                    // ÈÅøÂÖçÂú®ËæπÁºò2Ê†ºÂÜÖÁîüÊàêÊàøÂ≠ê
                    house = {
                        x: Math.floor(Math.random() * (tileCount - 4)) + 2,
                        y: Math.floor(Math.random() * (tileCount - 4)) + 2
                    };
                    attempts++;
                } while (isPositionOccupied(house.x, house.y) && attempts < 100);
                
                if (attempts >= 100) {
                    house = {x: 3, y: 3}; // Â§áÁî®‰ΩçÁΩÆ
                }
                
                if (houseHintElement) {
                    houseHintElement.style.display = 'block';
                }
            } catch (error) {
                console.error('ÁîüÊàêÊàøÂ≠êÂ§±Ë¥•:', error);
            }
        }
        
        // Ê£ÄÊü•‰ΩçÁΩÆÊòØÂê¶Ë¢´Âç†Áî®
        function isPositionOccupied(x, y, excludeCurrentFood = false) {
            try {
                // Ê£ÄÊü•ËõáË∫´
                for (let segment of snake) {
                    if (segment.x === x && segment.y === y) return true;
                }
                
                // Ê£ÄÊü•ÈöúÁ¢çÁâ©
                const level = levels[currentLevel];
                if (level && level.obstacles) {
                    for (let obstacle of level.obstacles) {
                        if (obstacle.x === x && obstacle.y === y) return true;
                    }
                }
                
                // Ê£ÄÊü•È£üÁâ©ÔºàÂèØÈÄâÊã©ÊéíÈô§ÂΩìÂâçÈ£üÁâ©‰ΩçÁΩÆÔºâ
                if (!excludeCurrentFood && food && food.x === x && food.y === y) return true;
                
                // Ê£ÄÊü•ÊàøÂ≠ê
                if (house && house.x === x && house.y === y) return true;
                
                return false;
            } catch (error) {
                console.error('Ê£ÄÊü•‰ΩçÁΩÆÂç†Áî®Â§±Ë¥•:', error);
                return false;
            }
        }
        
        // ÁªòÂà∂Ê∏∏ÊàèÂÖÉÁ¥†
        function drawGame() {
            try {
                if (!ctx || !canvas) return;
                
                // Ê∏ÖÁ©∫ÁîªÂ∏É
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ÁªòÂà∂ÈöúÁ¢çÁâ© - Â§ß‰æøemoji
                const level = levels[currentLevel];
                if (level && level.obstacles) {
                    ctx.font = `${gridSize-2}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    for (let obstacle of level.obstacles) {
                        ctx.fillText('üí©', 
                            obstacle.x * gridSize + gridSize/2, 
                            obstacle.y * gridSize + gridSize/2
                        );
                    }
                }
                
                // ÁªòÂà∂Â¶àÂ¶àËßíËâ≤ÔºàÂú®ÈöêËóèÂÖ≥Âç°‰∏≠Ôºâ
                if (mama && currentLevel === 5) {
                    ctx.font = `${gridSize-2}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('üë©', 
                        mama.x * gridSize + gridSize/2, 
                        mama.y * gridSize + gridSize/2
                    );
                    
                    // Ê∑ªÂä†ËøΩÂáªÊïàÊûúÔºàÁ∫¢Ëâ≤ÂÖâÁéØÔºâ
                    ctx.strokeStyle = '#FF1493';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(mama.x * gridSize + gridSize/2, mama.y * gridSize + gridSize/2, gridSize/2 + 2, 0, 2 * Math.PI);
                    ctx.stroke();
                }
                
                // ÁªòÂà∂ËõáË∫´ÔºàÈô§‰∫ÜÂ§¥ÈÉ®ÂíåÂ∞æÂ∑¥Ôºâ
                if (snake.length > 1) {
                    for (let i = 1; i < snake.length - 1; i++) {
                        const segment = snake[i];
                        // ÁÅ∞Ëâ≤ËõáË∫´
                        ctx.fillStyle = '#808080';
                        ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
                        
                        // Ê∑ªÂä†ÈªëËâ≤ÊñëÁÇπ
                        ctx.fillStyle = '#000000';
                        ctx.beginPath();
                        ctx.arc(segment.x * gridSize + gridSize/3, segment.y * gridSize + gridSize/3, 1, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(segment.x * gridSize + 2*gridSize/3, segment.y * gridSize + 2*gridSize/3, 1, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                }
                
                // ÁªòÂà∂ËõáÂ∞æÔºàÊúÄÂêé‰∏Ä‰∏™ÂÉèÁ¥†Ôºâ- ÁÅ∞Ëâ≤Á≤óÁ∫ø
                if (snake.length > 1) {
                    const tail = snake[snake.length - 1];
                    const beforeTail = snake[snake.length - 2];
                    
                    ctx.strokeStyle = '#808080';
                    ctx.lineWidth = 4;
                    ctx.lineCap = 'round';
                    
                    // ËÆ°ÁÆóÂ∞æÂ∑¥ÊñπÂêë
                    const tailX = tail.x * gridSize + gridSize/2;
                    const tailY = tail.y * gridSize + gridSize/2;
                    const beforeTailX = beforeTail.x * gridSize + gridSize/2;
                    const beforeTailY = beforeTail.y * gridSize + gridSize/2;
                    
                    // ÁªòÂà∂‰ªéÂ∞æÂ∑¥‰∏≠ÂøÉÂêëÂ§ñÂª∂‰º∏ÁöÑÁ∫ø
                    const dx = tailX - beforeTailX;
                    const dy = tailY - beforeTailY;
                    const length = Math.sqrt(dx*dx + dy*dy);
                    const unitX = dx / length;
                    const unitY = dy / length;
                    
                    ctx.beginPath();
                    ctx.moveTo(tailX, tailY);
                    ctx.lineTo(tailX + unitX * gridSize/2, tailY + unitY * gridSize/2);
                    ctx.stroke();
                }
                
                // ÁªòÂà∂Êù•Á¶èÁöÑÂ§¥ÈÉ® - ÁÅ∞Ëâ≤ÂÉèÁ¥†ÁãóÂ§¥
                if (snake.length > 0) {
                    const head = snake[0];
                    const x = head.x * gridSize;
                    const y = head.y * gridSize;
                    
                    // ÁãóÂ§¥‰∏ª‰Ωì - ÁÅ∞Ëâ≤
                    ctx.fillStyle = '#808080';
                    ctx.fillRect(x + 2, y + 2, gridSize - 4, gridSize - 4);
                    
                    // ÁãóËÄ≥Êúµ - Ê∑±ÁÅ∞Ëâ≤
                    ctx.fillStyle = '#606060';
                    ctx.fillRect(x + 1, y + 1, 3, 4); // Â∑¶ËÄ≥
                    ctx.fillRect(x + gridSize - 4, y + 1, 3, 4); // Âè≥ËÄ≥
                    
                    // ÁãóÁúºÁùõ - ÈªëËâ≤
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(x + 4, y + 4, 2, 2); // Â∑¶Áúº
                    ctx.fillRect(x + gridSize - 6, y + 4, 2, 2); // Âè≥Áúº
                    
                    // ÁãóÈºªÂ≠ê - ÈªëËâ≤
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(x + gridSize/2 - 1, y + 7, 2, 2);
                    
                    // ÁãóÂò¥Â∑¥ - Ê∑±ÁÅ∞Ëâ≤Á∫øÊù°
                    ctx.fillStyle = '#404040';
                    ctx.fillRect(x + gridSize/2 - 2, y + 10, 4, 1); // Âò¥Â∑¥Á∫ø
                    
                    // ÁãóÈºªÂ≠êÂà∞Âò¥Â∑¥ÁöÑËøûÁ∫ø
                    ctx.fillRect(x + gridSize/2, y + 9, 1, 1);
                }
                
                // ÁªòÂà∂È£üÁâ© - È¶ôËÇ†emoji
                if (food) {
                    ctx.font = `${gridSize-2}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('üå≠', 
                        food.x * gridSize + gridSize/2, 
                        food.y * gridSize + gridSize/2
                    );
                }
                
                // ÁªòÂà∂ÊàøÂ≠ê
                if (house) {
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(house.x * gridSize, house.y * gridSize, gridSize - 2, gridSize - 2);
                    
                    // ÁªòÂà∂ÊàøÂ≠êÂõæÊ†á
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(house.x * gridSize + 2, house.y * gridSize + gridSize/2, gridSize - 4, gridSize/2 - 2);
                    ctx.fillStyle = '#DC143C';
                    ctx.beginPath();
                    ctx.moveTo(house.x * gridSize + 1, house.y * gridSize + gridSize/2);
                    ctx.lineTo(house.x * gridSize + gridSize/2, house.y * gridSize + 1);
                    ctx.lineTo(house.x * gridSize + gridSize - 1, house.y * gridSize + gridSize/2);
                    ctx.closePath();
                    ctx.fill();
                }

                // ÁªòÂà∂Â¶àÂ¶àËßíËâ≤ÔºàÂú®ÈöêËóèÂÖ≥Âç°‰∏≠Ôºâ
                if (mama && currentLevel === 5) {
                    ctx.font = `${gridSize-2}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('üë©', 
                        mama.x * gridSize + gridSize/2, 
                        mama.y * gridSize + gridSize/2
                    );
                    
                    // Ê∑ªÂä†ËøΩÂáªÊïàÊûúÔºàÁ∫¢Ëâ≤ÂÖâÁéØÔºâ
                    ctx.strokeStyle = '#FF1493';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(mama.x * gridSize + gridSize/2, mama.y * gridSize + gridSize/2, gridSize/2 + 2, 0, 2 * Math.PI);
                    ctx.stroke();
                }

                // ÁªòÂà∂ÊéâËêΩÁöÑÂ§ß‰æøÔºàÈöêËóèÂÖ≥Âç°Ôºâ
                if (currentLevel === 5 && fallingPoop.length > 0) {
                    ctx.font = `${gridSize-2}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    for (let poop of fallingPoop) {
                        ctx.fillText('üí©', 
                            poop.x * gridSize + gridSize/2, 
                            poop.y * gridSize + gridSize/2
                        );
                    }
                }
                
            } catch (error) {
                console.error('ÁªòÂà∂Ê∏∏ÊàèÂ§±Ë¥•:', error);
                updateDebug('ÁªòÂà∂ÈîôËØØ: ' + error.message);
            }
        }
        
        // ÁßªÂä®Ëõá
function moveSnake() {
    try {
        if (dx === 0 && dy === 0) return;
        
        const head = {x: snake[0].x + dx, y: snake[0].y + dy};
        let gameOverReason = '';
        
        // Ê£ÄÊü•ËæπÁïåÁ¢∞Êíû
        const level = levels[currentLevel];
        if (level && level.isInfinite) {
            // Êó†ËæπÁïåÊ®°ÂºèÔºöÁ©øË∂äËæπÁïå
            if (head.x < 0) head.x = tileCount - 1;
            if (head.x >= tileCount) head.x = 0;
            if (head.y < 0) head.y = tileCount - 1;
            if (head.y >= tileCount) head.y = 0;
        } else {
            // ÊôÆÈÄöÊ®°ÂºèÔºöÊíûÂ¢ôÊ∏∏ÊàèÁªìÊùü
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                gameOverReason = 'Êù•Á¶èÊíûÂà∞‰∫ÜÂ¢ôÔºåÂ•ΩÁóõ';
                gameOver(gameOverReason);
                return;
            }
        }
        
        // Ê£ÄÊü•ÈöúÁ¢çÁâ©Á¢∞Êíû
        if (level && level.obstacles) {
            for (let obstacle of level.obstacles) {
                if (head.x === obstacle.x && head.y === obstacle.y) {
                    if (currentLevel === 5) {
                        // ÈöêËóèÂÖ≥Âç°ÔºöÂêÉÂ§ß‰æøÂáèÈïøÂ∫¶
                        if (snake.length > 1) {
                            snake.pop(); // ÂáèÂ∞ë‰∏ÄËäÇË∫´‰Ωì
                            snake.pop(); // ÂÜçÂáèÂ∞ë‰∏ÄËäÇÔºàÂõ†‰∏∫ÂêéÈù¢‰ºöunshiftÊ∑ªÂä†Â§¥ÈÉ®Ôºâ
                            updateDebug('Êù•Á¶èÂêÉ‰∫ÜÂ§ß‰æøÔºåË∫´‰ΩìÂèòÁü≠‰∫ÜÔºÅ');
                        } else {
                            // Âè™Ââ©Â§¥ÈÉ®Êó∂Ê∏∏ÊàèÁªìÊùü
                            gameOverReason = 'Êù•Á¶èÂè™Ââ©Â§¥ÈÉ®ËøòÂêÉÂ§ß‰æøÔºåË¢´Â¶àÂ¶àÊäì‰Ωè‰∫ÜÔºÅ';
                            gameOver(gameOverReason);
                            return;
                        }
                    } else {
                        // ÂÖ∂‰ªñÂÖ≥Âç°ÔºöÁõ¥Êé•Ê∏∏ÊàèÁªìÊùü
                        gameOverReason = 'Êù•Á¶èÂêÉ‰∫ÜÂ§ß‰æøË¢´Â¶àÂ¶àÊâì‰∫Ü‰∏ÄÈ°ø';
                        gameOver(gameOverReason);
                        return;
                    }
                }
            }
        }
        

        
        snake.unshift(head);
        
        // Ê£ÄÊü•ÊòØÂê¶ÂêÉÂà∞ÊàøÂ≠êÔºàÈÄöÂÖ≥Ôºâ
        if (house && head.x === house.x && head.y === house.y) {
            levelComplete();
            return;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶ÂêÉÂà∞È£üÁâ©
        if (food && head.x === food.x && head.y === food.y && !house) {
            score += 10;
            if (scoreElement) scoreElement.textContent = score;
            
            // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞ÁõÆÊ†áÂàÜÊï∞
            if (score >= level.targetScore && !canSpawnHouse) {
                canSpawnHouse = true;
                generateHouse();
                // ÂÅúÊ≠¢ÁîüÊàêÈ£üÁâ©
                food = null;
            } else if (!canSpawnHouse) {
                generateFood();
            }
        } else {
            snake.pop();
        }
        
    } catch (error) {
        console.error('ÁßªÂä®ËõáÂ§±Ë¥•:', error);
        gameOver('Ê∏∏ÊàèÂá∫Áé∞ÈîôËØØ');
    }
}
        
        // Ê∏∏ÊàèÁªìÊùü
function gameOver(reason = 'Ê∏∏ÊàèÁªìÊùü') {
    try {
        gameRunning = false;
        if (gameLoopId) {
            clearTimeout(gameLoopId);
            gameLoopId = null;
        }
        // ÂÅúÊ≠¢ËÆ°Êó∂Âô®
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        // Êõ¥Êñ∞Ê∏∏ÊàèÁªìÊùüÁïåÈù¢ÁöÑÊ†áÈ¢ò
        const gameOverTitle = document.querySelector('#gameOver h2');
        if (gameOverTitle) {
            gameOverTitle.textContent = reason;
        }
        
        if (finalScoreElement) finalScoreElement.textContent = score;
        
        // Êõ¥Êñ∞ÊúÄÁªàÊó∂Èó¥ÊòæÁ§∫
        const finalTimeElement = document.getElementById('finalTime');
        if (finalTimeElement && timerElement) {
            finalTimeElement.textContent = timerElement.textContent;
        }
        
        if (gameOverElement) gameOverElement.style.display = 'block';
        updateDebug('Ê∏∏ÊàèÁªìÊùü: ' + reason);
    } catch (error) {
        console.error('Ê∏∏ÊàèÁªìÊùüÂ§ÑÁêÜÂ§±Ë¥•:', error);
    }
}
        
        // ÂÖ≥Âç°ÂÆåÊàê
        function levelComplete() {
    try {
        gameRunning = false;
        if (gameLoopId) {
            clearTimeout(gameLoopId);
            gameLoopId = null;
        }
        // ÂÅúÊ≠¢ËÆ°Êó∂Âô®
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        // ËÆ°ÁÆóÊòüÁ∫ßËØÑÂÆö
        const level = levels[currentLevel];
        const targetTime = level.targetScore * 10; // 10Áßí = 3Êòü
        let stars = 1;
        if (gameTime <= targetTime) {
            stars = 3;
        } else if (gameTime <= targetTime * 2) {
            stars = 2;
        }
        
        // ‰øùÂ≠òÊúÄÈ´òÊòüÁ∫ß
        if (!gameProgress.levelStars[currentLevel] || gameProgress.levelStars[currentLevel] < stars) {
            gameProgress.levelStars[currentLevel] = stars;
        }
        
        // Êõ¥Êñ∞ËøõÂ∫¶
        if (!gameProgress.completedLevels.includes(currentLevel)) {
            gameProgress.completedLevels.push(currentLevel);
        }

        // Ëß£ÈîÅ‰∏ã‰∏ÄÂÖ≥ÈÄªËæë
        const nextLevelIndex = currentLevel + 1;
        let isNewUnlock = false;
        let isHiddenUnlock = false;
        
        // ÁâπÊÆäÂ§ÑÁêÜÔºöÁ¨¨‰∫îÂÖ≥ÔºàÁ¥¢Âºï4ÔºâÈÄöÂÖ≥ÂêéËß£ÈîÅÈöêËóèÂÖ≥Âç°Á¨¨ÂÖ≠ÂÖ≥ÔºàÁ¥¢Âºï5Ôºâ
        if (currentLevel === 4 && !gameProgress.completedLevels.includes(5)) {
            isHiddenUnlock = true;
            if (gameProgress.unlockedLevels <= 5) {
                gameProgress.unlockedLevels = 6;
                isNewUnlock = true;
            }
        } else if (nextLevelIndex < levels.length && !levels[nextLevelIndex].isHidden && gameProgress.unlockedLevels <= nextLevelIndex) {
            gameProgress.unlockedLevels = nextLevelIndex + 1;
            isNewUnlock = true;
        }
        
        saveProgress();
        
        // ÊòæÁ§∫ÂÆåÊàêÁïåÈù¢
        const completedLevelElement = document.getElementById('completedLevel');
        const levelScoreElement = document.getElementById('levelScore');
        const unlockMessage = document.getElementById('unlockMessage');
        const starsElement = document.getElementById('starDisplay');
        
        if (completedLevelElement) completedLevelElement.textContent = levels[currentLevel].name;
        if (levelScoreElement) levelScoreElement.textContent = score;
        
        // Êõ¥Êñ∞ÂÆåÊàêÊó∂Èó¥ÊòæÁ§∫
        const completionTimeElement = document.getElementById('completionTime');
        if (completionTimeElement && timerElement) {
            completionTimeElement.textContent = timerElement.textContent;
        }
        
        if (unlockMessage) {
            if (isHiddenUnlock) {
                unlockMessage.innerHTML = '<p style="color: #FF69B4;">üéä Ëß£ÈîÅÈöêËóèÂÖ≥Âç°ÔºöÂ¶àÂ¶àÁöÑËøΩÂáªÔºÅ</p>';
                unlockMessage.style.display = 'block';
            } else if (isNewUnlock) {
                unlockMessage.innerHTML = '<p style="color: #FFD700;">üéä Ëß£ÈîÅÊñ∞ÂÖ≥Âç°ÔºÅ</p>';
                unlockMessage.style.display = 'block';
            } else {
                unlockMessage.style.display = 'none';
            }
        }
        
        if (starsElement) {
            starsElement.textContent = '‚òÖ'.repeat(stars) + '‚òÜ'.repeat(3 - stars);
        }
        if (levelCompleteElement) levelCompleteElement.style.display = 'block';
        
        updateDebug('ÂÖ≥Âç°ÂÆåÊàê');
    } catch (error) {
        console.error('ÂÖ≥Âç°ÂÆåÊàêÂ§ÑÁêÜÂ§±Ë¥•:', error);
    }
        }
        
        // ‰∏ã‰∏ÄÂÖ≥
        function nextLevel() {
            try {
                if (currentLevel < levels.length - 1) {
                    currentLevel++;
                    if (levelCompleteElement) levelCompleteElement.style.display = 'none';
                    resetLevel();
                } else {
                    alert('üéâ ÊÅ≠ÂñúÊÇ®ÂÆåÊàê‰∫ÜÊâÄÊúâÂÖ≥Âç°ÔºÅÊù•Á¶èÊàêÂäüÂõûÂà∞‰∫ÜÂÆ∂ÔºÅ');
                    showMainMenu();
                }
            } catch (error) {
                console.error('‰∏ã‰∏ÄÂÖ≥Â§±Ë¥•:', error);
            }
        }
        
        // Ê∏∏Êàè‰∏ªÂæ™ÁéØ
function gameLoop() {
    try {
        if (!gameRunning || gamePaused || developerMode) return; // ÂºÄÂèëËÄÖÊ®°Âºè‰∏ã‰∏çËá™Âä®Âæ™ÁéØ
        
        moveSnake();
        moveMama();
        dropPoop();
        updateFallingPoop();
        drawGame();
        
        if (gameRunning && !developerMode) {
            const level = levels[currentLevel];
            gameLoopId = setTimeout(gameLoop, level.speed);
        }
    } catch (error) {
        console.error('Ê∏∏ÊàèÂæ™ÁéØÈîôËØØ:', error);
        updateDebug('Âæ™ÁéØÈîôËØØ: ' + error.message);
        gameOver();
    }
}

// ÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè
function activateDeveloperMode() {
    try {
        developerMode = true;
        manualMode = true;
        
        // Ê∏ÖÈô§ÊâÄÊúâÈöúÁ¢çÁâ©
        const level = levels[currentLevel];
        if (level && level.obstacles) {
            level.obstacles = []; // Ê∏ÖÁ©∫ÈöúÁ¢çÁâ©Êï∞ÁªÑ
        }
        
        // ÂÅúÊ≠¢Ëá™Âä®Ê∏∏ÊàèÂæ™ÁéØ
        if (gameLoopId) {
            clearTimeout(gameLoopId);
            gameLoopId = null;
        }
        
        // ÈáçÊñ∞ÁªòÂà∂Ê∏∏ÊàèÔºà‰∏çÊòæÁ§∫ÈöúÁ¢çÁâ©Ôºâ
        drawGame();
        
        // ÊòæÁ§∫ÂºÄÂèëËÄÖÊ®°ÂºèÊèêÁ§∫
        updateDebug('üîß ÂºÄÂèëËÄÖÊ®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºÅÊâÄÊúâÂ§ß‰æøÂ∑≤Ê∏ÖÈô§Ôºå‰ΩøÁî®ÊñπÂêëÈîÆÊâãÂä®ÊéßÂà∂Êù•Á¶è„ÄÇÊåâESCÈÄÄÂá∫ÂºÄÂèëËÄÖÊ®°Âºè„ÄÇ');
        
        // ÂèØÈÄâÔºöÂú®Â±èÂπï‰∏äÊòæÁ§∫ÂºÄÂèëËÄÖÊ®°ÂºèÊ†áËØÜ
        showDeveloperModeIndicator();
        
        console.log('ÂºÄÂèëËÄÖÊ®°ÂºèÂ∑≤ÊøÄÊ¥ª');
    } catch (error) {
        console.error('ÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°ÂºèÂ§±Ë¥•:', error);
    }
}

// ÈÄÄÂá∫ÂºÄÂèëËÄÖÊ®°Âºè
function deactivateDeveloperMode() {
    try {
        developerMode = false;
        manualMode = false;
        upKeyPressCount = 0;
        
        // ÊÅ¢Â§çÂéüÂßãÈöúÁ¢çÁâ©ÔºàÈáçÊñ∞Âä†ËΩΩÂÖ≥Âç°Ôºâ
        const originalLevel = levels[currentLevel];
        // ËøôÈáåÈúÄË¶Å‰ªéÂéüÂßãÂÖ≥Âç°Êï∞ÊçÆÊÅ¢Â§çÈöúÁ¢çÁâ©
        // ÂÅáËÆæÊàë‰ª¨ÊúâÂéüÂßãÂÖ≥Âç°Êï∞ÊçÆÁöÑÂ§á‰ªΩ
        resetLevel(); // ÈáçÁΩÆÂÖ≥Âç°‰ºöÊÅ¢Â§çÊâÄÊúâÂéüÂßãËÆæÁΩÆ
        
        updateDebug('ÂºÄÂèëËÄÖÊ®°ÂºèÂ∑≤ÈÄÄÂá∫ÔºåÊ∏∏ÊàèÊÅ¢Â§çÊ≠£Â∏∏');
        hideDeveloperModeIndicator();
        
        console.log('ÂºÄÂèëËÄÖÊ®°ÂºèÂ∑≤ÈÄÄÂá∫');
    } catch (error) {
        console.error('ÈÄÄÂá∫ÂºÄÂèëËÄÖÊ®°ÂºèÂ§±Ë¥•:', error);
    }
}

// ÊâãÂä®ÁßªÂä®ËõáÔºà‰∏ÄÊ≠•‰∏ÄÊ≠•Ôºâ
function manualMoveSnake() {
    try {
        if (!developerMode || !gameRunning || gamePaused) return;
        
        const head = {x: snake[0].x + dx, y: snake[0].y + dy};
        
        // Ê£ÄÊü•ËæπÁïåÁ¢∞Êíû
        if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
            updateDebug('Êù•Á¶èÊíûÂà∞‰∫ÜÂ¢ôÂ£Å');
            return; // ÂºÄÂèëËÄÖÊ®°Âºè‰∏ã‰∏ç‰ºöÊ∏∏ÊàèÁªìÊùü
        }
        
        // Ê£ÄÊü•Ëá™Ë∫´Á¢∞ÊíûÔºàÂºÄÂèëËÄÖÊ®°Âºè‰∏ãÂèØ‰ª•ÈÄâÊã©ÂøΩÁï•Ôºâ
        for (let segment of snake) {
            if (head.x === segment.x && head.y === segment.y) {
                updateDebug('Êù•Á¶èÊíûÂà∞‰∫ÜËá™Â∑±');
                return; // ÊàñËÄÖÂèØ‰ª•ÈÄâÊã©ÂøΩÁï•Ëøô‰∏™Á¢∞Êíû
            }
        }
        
        snake.unshift(head);
        
        // Ê£ÄÊü•ÊòØÂê¶ÂêÉÂà∞ÊàøÂ≠êÔºàÈÄöÂÖ≥Ôºâ
        if (house && head.x === house.x && head.y === house.y) {
            levelComplete();
            return;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶ÂêÉÂà∞È£üÁâ©
        if (food && head.x === food.x && head.y === food.y && !house) {
            score += 10;
            if (scoreElement) scoreElement.textContent = score;
            
            // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞ÁõÆÊ†áÂàÜÊï∞
            const level = levels[currentLevel];
            if (score >= level.targetScore && !canSpawnHouse) {
                canSpawnHouse = true;
                generateHouse();
                food = null;
            } else if (!canSpawnHouse) {
                generateFood();
            }
        } else {
            snake.pop();
        }
        
        // ÈáçÊñ∞ÁªòÂà∂Ê∏∏Êàè
        drawGame();
        
    } catch (error) {
        console.error('ÊâãÂä®ÁßªÂä®Â§±Ë¥•:', error);
    }
}

// ÊòæÁ§∫ÂºÄÂèëËÄÖÊ®°ÂºèÊåáÁ§∫Âô®
function showDeveloperModeIndicator() {
    try {
        // Âú®Ê∏∏ÊàèÁïåÈù¢Ê∑ªÂä†ÂºÄÂèëËÄÖÊ®°ÂºèÊ†áËØÜ
        let indicator = document.getElementById('developerModeIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'developerModeIndicator';
            indicator.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(255, 0, 0, 0.8);
                color: white;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 12px;
                z-index: 1000;
                font-family: Arial, sans-serif;
            `;
            indicator.textContent = 'üîß ÂºÄÂèëËÄÖÊ®°Âºè';
            document.body.appendChild(indicator);
        }
        indicator.style.display = 'block';
    } catch (error) {
        console.error('ÊòæÁ§∫ÂºÄÂèëËÄÖÊ®°ÂºèÊåáÁ§∫Âô®Â§±Ë¥•:', error);
    }
}

// ÈöêËóèÂºÄÂèëËÄÖÊ®°ÂºèÊåáÁ§∫Âô®
function hideDeveloperModeIndicator() {
    try {
        const indicator = document.getElementById('developerModeIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    } catch (error) {
        console.error('ÈöêËóèÂºÄÂèëËÄÖÊ®°ÂºèÊåáÁ§∫Âô®Â§±Ë¥•:', error);
    }
}
        
        // ÂºÄÂßãÊ∏∏Êàè
        function startGame() {
    try {
        updateDebug('ÂºÄÂßãÊ∏∏Êàè...');
        
        if (gameRunning) return;
        
        // Ê∏ÖÈô§‰πãÂâçÁöÑÂæ™ÁéØÂíåËÆ°Êó∂Âô®
        if (gameLoopId) {
            clearTimeout(gameLoopId);
            gameLoopId = null;
        }
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        // ÈöêËóèÂÖ≥Âç°ÂâßÊÉÖÊèêÁ§∫
        if (currentLevel === 5) {
            alert('üêï Êù•Á¶èËÉåÁùÄÂ¶àÂ¶àË∑ë‰∫ÜÂá∫Êù•Ôºå‰∏çË¶ÅËÆ©Â¶àÂ¶àÊäìÂà∞ÔºåËøôÂõûÊù•Á¶èÂèØ‰ª•ÂêÉÂ§ß‰æø‰∫ÜÔºåÂ¶àÂ¶àÂÜç‰πüÁÆ°‰∏çÁùÄÂíØÔºÅ');
        }
        
        // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
        snake = [{x: 10, y: 10}];
        dx = 1;
        dy = 0;
        score = 0;
        if (scoreElement) scoreElement.textContent = score;
        gameRunning = true;
        gamePaused = false;
        canSpawnHouse = false;
        house = null;
        
        // ÈáçÁΩÆÂπ∂ÂêØÂä®ËÆ°Êó∂Âô®
        startTime = Date.now();
        gameTime = 0;
        if (timerElement) timerElement.textContent = '00:00';
        timerInterval = setInterval(updateTimer, 1000);
        
        // ÈöêËóèÂºπÁ™ó
        if (gameOverElement) gameOverElement.style.display = 'none';
        if (levelCompleteElement) levelCompleteElement.style.display = 'none';
        if (houseHintElement) houseHintElement.style.display = 'none';
        
        generateFood();
        drawGame();
        
        updateDebug('Ê∏∏ÊàèËøêË°å‰∏≠');
        gameLoop();
        
    } catch (error) {
        console.error('ÂºÄÂßãÊ∏∏ÊàèÂ§±Ë¥•:', error);
        updateDebug('ÂºÄÂßãÂ§±Ë¥•: ' + error.message);
    }
        }
        
        // ÈáçÁΩÆÂÖ≥Âç°
        function resetLevel() {
            try {
                gameRunning = false;
                if (gameLoopId) {
                    clearTimeout(gameLoopId);
                    gameLoopId = null;
                }
                updateLevelDisplay();
                startGame();
            } catch (error) {
                console.error('ÈáçÁΩÆÂÖ≥Âç°Â§±Ë¥•:', error);
            }
        }
        
        // ÊöÇÂÅúÊ∏∏Êàè
        function pauseGame() {
    try {
        if (!gameRunning) return;
        gamePaused = !gamePaused;
        
        if (gamePaused) {
            // ÊöÇÂÅúÊó∂ÂÅúÊ≠¢ËÆ°Êó∂Âô®
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        } else {
            // ÁªßÁª≠Êó∂ÈáçÊñ∞ÂêØÂä®ËÆ°Êó∂Âô®
            startTime = Date.now() - (gameTime * 1000);
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        updateDebug(gamePaused ? 'Ê∏∏ÊàèÊöÇÂÅú' : 'Ê∏∏ÊàèÁªßÁª≠');
        if (!gamePaused) {
            gameLoop();
        }
    } catch (error) {
        console.error('ÊöÇÂÅúÊ∏∏ÊàèÂ§±Ë¥•:', error);
    }
        }
        
        // ÈîÆÁõòÊéßÂà∂
document.addEventListener('keydown', function(e) {
    try {
        // ÂºÄÂèëËÄÖÊ®°ÂºèÊ£ÄÊµã - ËøûÁª≠Êåâ3Ê¨°‰∏äÈîÆ
        if (e.key === 'ArrowUp') {
            const currentTime = Date.now();
            if (currentTime - lastUpKeyTime < 500) { // 500msÂÜÖËøûÁª≠ÊåâÈîÆ
                upKeyPressCount++;
            } else {
                upKeyPressCount = 1; // ÈáçÁΩÆËÆ°Êï∞
            }
            lastUpKeyTime = currentTime;
            
            // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞3Ê¨°
            if (upKeyPressCount >= 3 && !developerMode) {
                activateDeveloperMode();
                return;
            }
        } else {
            upKeyPressCount = 0; // ÊåâÂÖ∂‰ªñÈîÆÈáçÁΩÆËÆ°Êï∞
        }
        
        // ÂºÄÂèëËÄÖÊ®°Âºè‰∏ãÁöÑÊâãÂä®ÊéßÂà∂
        if (developerMode && gameRunning && !gamePaused) {
            switch(e.key) {
                case 'ArrowUp':
                    if (dy !== 1) { 
                        dx = 0; dy = -1;
                        manualMoveSnake(); // ÊâãÂä®ÁßªÂä®‰∏ÄÊ≠•
                    }
                    break;
                case 'ArrowDown':
                    if (dy !== -1) { 
                        dx = 0; dy = 1;
                        manualMoveSnake();
                    }
                    break;
                case 'ArrowLeft':
                    if (dx !== 1) { 
                        dx = -1; dy = 0;
                        manualMoveSnake();
                    }
                    break;
                case 'ArrowRight':
                    if (dx !== -1) { 
                        dx = 1; dy = 0;
                        manualMoveSnake();
                    }
                    break;
                case ' ':
                    e.preventDefault();
                    pauseGame();
                    break;
                case 'Escape': // ESCÈîÆÈÄÄÂá∫ÂºÄÂèëËÄÖÊ®°Âºè
                    deactivateDeveloperMode();
                    break;
            }
            return;
        }
        
        // ÊôÆÈÄöÊ®°ÂºèÁöÑÊéßÂà∂ÔºàÂéüÊúâÈÄªËæëÔºâ
        if (!gameRunning || gamePaused) return;
        
        switch(e.key) {
            case 'ArrowUp':
                if (dy !== 1) { dx = 0; dy = -1; }
                break;
            case 'ArrowDown':
                if (dy !== -1) { dx = 0; dy = 1; }
                break;
            case 'ArrowLeft':
                if (dx !== 1) { dx = -1; dy = 0; }
                break;
            case 'ArrowRight':
                if (dx !== -1) { dx = 1; dy = 0; }
                break;
            case ' ':
                e.preventDefault();
                pauseGame();
                break;
        }
    } catch (error) {
        console.error('ÈîÆÁõòÊéßÂà∂Â§±Ë¥•:', error);
    }
});
        
        // Ëß£ÈîÅÂÖ≥Âç°ÂäüËÉΩ
let rightClickCount = 0;
let lastRightClickTime = 0;
let unlockModeActive = false;

// Ê∑ªÂä†Âè≥ÈîÆ‰∫ã‰ª∂ÁõëÂê¨Âô®Âà∞ÂÖ≥Âç°ÈÄâÊã©È°µÈù¢
function setupUnlockMode() {
    const levelGrid = document.getElementById('levelGrid');
    if (levelGrid) {
        levelGrid.addEventListener('contextmenu', function(e) {
            e.preventDefault(); // ÈòªÊ≠¢ÈªòËÆ§Âè≥ÈîÆËèúÂçï
            
            const now = Date.now();
            if (now - lastRightClickTime < 1000) { // 1ÁßíÂÜÖÁöÑËøûÁª≠ÁÇπÂáª
                rightClickCount++;
            } else {
                rightClickCount = 1; // ÈáçÁΩÆËÆ°Êï∞
            }
            lastRightClickTime = now;
            
            if (rightClickCount >= 3 && !unlockModeActive) {
                unlockModeActive = true;
                // Ëß£ÈîÅÊâÄÊúâÂÖ≥Âç°
                gameProgress.unlockedLevels = levels.length;
                for (let i = 0; i < levels.length; i++) {
                    if (!gameProgress.completedLevels.includes(i)) {
                        gameProgress.completedLevels.push(i);
                    }
                    gameProgress.levelStars[i] = 3; // ÁªôÊâÄÊúâÂÖ≥Âç°3Êòü
                }
                saveProgress();
                generateLevelGrid(); // ÈáçÊñ∞ÁîüÊàêÂÖ≥Âç°ÁΩëÊ†º
                
                // Ê∑ªÂä†Ëß£ÈîÅÊ®°ÂºèÊåáÁ§∫Âô®
                let unlockIndicator = document.getElementById('unlockModeIndicator');
                if (!unlockIndicator) {
                    unlockIndicator = document.createElement('div');
                    unlockIndicator.id = 'unlockModeIndicator';
                    unlockIndicator.style.cssText = `
                        position: fixed;
                        top: 50px;
                        right: 10px;
                        background: rgba(255, 215, 0, 0.9);
                        color: black;
                        padding: 8px 12px;
                        border-radius: 8px;
                        font-size: 14px;
                        z-index: 1000;
                        font-family: Arial, sans-serif;
                        border: 2px solid #FFD700;
                    `;
                    unlockIndicator.textContent = 'üîì Ëß£ÈîÅÊ®°Âºè';
                    document.body.appendChild(unlockIndicator);
                }
                unlockIndicator.style.display = 'block';
                
                alert('üéä Ëß£ÈîÅÊ®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºÅÊâÄÊúâÂÖ≥Âç°Áé∞Âú®ÈÉΩÂèØ‰ª•Ê∏∏Áé©‰∫ÜÔºÅ');
                rightClickCount = 0; // ÈáçÁΩÆËÆ°Êï∞
            }
        });
    }
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    try {
        loadProgress();
        initGame();
        setupTouchControls();
        setupUnlockMode(); // ËÆæÁΩÆËß£ÈîÅÊ®°Âºè
        updateProgressDisplay(); // Á°Æ‰øùËøõÂ∫¶ÊòæÁ§∫Ê≠£Á°Æ
    } catch (error) {
        console.error('È°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•:', error);
    }
});
        
        // ‰ªéÊ∏∏ÊàèÁªìÊùüÁïåÈù¢Ë∑≥ËΩ¨Âà∞ÂÖ≥Âç°ÈÄâÊã©
        function gameOverToLevelSelect() {
            try {
                if (gameOverElement) gameOverElement.style.display = 'none';
                showLevelSelect();
            } catch (error) {
                console.error('Ë∑≥ËΩ¨Âà∞ÂÖ≥Âç°ÈÄâÊã©Â§±Ë¥•:', error);
            }
        }
        
        // ‰ªéÂÖ≥Âç°ÂÆåÊàêÁïåÈù¢Ë∑≥ËΩ¨Âà∞ÂÖ≥Âç°ÈÄâÊã©
        function levelCompleteToLevelSelect() {
            try {
                if (levelCompleteElement) levelCompleteElement.style.display = 'none';
                showLevelSelect();
            } catch (error) {
                console.error('Ë∑≥ËΩ¨Âà∞ÂÖ≥Âç°ÈÄâÊã©Â§±Ë¥•:', error);
            }
        }
        
        // Ê∑ªÂä†Êõ¥Êñ∞ËÆ°Êó∂Âô®ÂáΩÊï∞
function updateTimer() {
    if (timerElement && gameRunning && !gamePaused) {
        gameTime = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(gameTime / 60);
        const seconds = gameTime % 60;
        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

// ÂàùÂßãÂåñÂ¶àÂ¶àËßíËâ≤Ôºà‰ªÖÂú®ÈöêËóèÂÖ≥Âç°Ôºâ
        function initMama() {
            try {
                if (currentLevel !== 5) { // Âè™Âú®Á¨¨ÂÖ≠ÂÖ≥ÔºàÈöêËóèÂÖ≥Âç°ÔºâÂá∫Áé∞
                    mama = null;
                    return;
                }
                
                // Âú®Âú∞ÂõæËßíËêΩÈöèÊú∫ÁîüÊàêÂ¶àÂ¶à
                const corners = [
                    {x: 1, y: 1},
                    {x: tileCount - 2, y: 1},
                    {x: 1, y: tileCount - 2},
                    {x: tileCount - 2, y: tileCount - 2}
                ];
                
                let attempts = 0;
                do {
                    mama = corners[Math.floor(Math.random() * corners.length)];
                    attempts++;
                } while (isPositionOccupied(mama.x, mama.y) && attempts < 10);
                
                mamaDirection = {x: 0, y: 0};
                mamaLastMoveTime = Date.now();
                const level = levels[currentLevel];
                mamaSpeed = level.speed * 2; // Â¶àÂ¶àÈÄüÂ∫¶ÊòØËõáÁöÑ‰∏ÄÂçä
                
                console.log('Â¶àÂ¶àÂ∑≤ÁîüÊàêÂú®‰ΩçÁΩÆ:', mama);
            } catch (error) {
                console.error('ÂàùÂßãÂåñÂ¶àÂ¶àÂ§±Ë¥•:', error);
            }
        }
        
        // Â¶àÂ¶àAIÁßªÂä®ÈÄªËæë
        function moveMama() {
            try {
                if (!mama || currentLevel !== 5 || !gameRunning || gamePaused) return;
                
                const now = Date.now();
                if (now - mamaLastMoveTime < mamaSpeed) return;
                
                const snakeHead = snake[0];
                let targetX = snakeHead.x;
                let targetY = snakeHead.y;
                
                // Ê∑ªÂä†ÈöèÊú∫ÊÄßÔºö30%Ê¶ÇÁéáÈöèÊú∫ÁßªÂä®Ôºå70%Ê¶ÇÁéáËøΩÂáª
                if (Math.random() < 0.3) {
                    // ÈöèÊú∫ÁßªÂä®
                    const directions = [
                        {x: -1, y: 0}, {x: 1, y: 0}, {x: 0, y: -1}, {x: 0, y: 1}
                    ];
                    const randomDir = directions[Math.floor(Math.random() * directions.length)];
                    targetX = mama.x + randomDir.x;
                    targetY = mama.y + randomDir.y;
                } else {
                    // Êô∫ËÉΩËøΩÂáªÔºöÂêëËõáÂ§¥ÊñπÂêëÁßªÂä®Ôºå‰ΩÜ‰∏çÁõ¥Â•î
                    const dx = snakeHead.x - mama.x;
                    const dy = snakeHead.y - mama.y;
                    
                    // Ê∑ªÂä†‰∏Ä‰∫õÈöèÊú∫ÂÅèÁßªÔºåÈÅøÂÖçËøá‰∫éÁõ¥Êé•
                    const randomOffset = Math.random() * 0.4 - 0.2; // -0.2 Âà∞ 0.2 ÁöÑÈöèÊú∫ÂÅèÁßª
                    
                    if (Math.abs(dx) > Math.abs(dy)) {
                        // ‰∏ªË¶ÅÂú®XÊñπÂêëÁßªÂä®
                        mamaDirection.x = dx > 0 ? 1 : -1;
                        mamaDirection.y = Math.random() < 0.3 ? (Math.random() < 0.5 ? 1 : -1) : 0;
                    } else {
                        // ‰∏ªË¶ÅÂú®YÊñπÂêëÁßªÂä®
                        mamaDirection.y = dy > 0 ? 1 : -1;
                        mamaDirection.x = Math.random() < 0.3 ? (Math.random() < 0.5 ? 1 : -1) : 0;
                    }
                    
                    targetX = mama.x + mamaDirection.x;
                    targetY = mama.y + mamaDirection.y;
                }
                
                // Ê£ÄÊü•ËæπÁïåÂíåÁ¢∞Êíû
                if (targetX >= 0 && targetX < tileCount && 
                    targetY >= 0 && targetY < tileCount && 
                    !isPositionOccupiedByObstacle(targetX, targetY)) {
                    
                    mama.x = targetX;
                    mama.y = targetY;
                    
                    // Ê£ÄÊü•ÊòØÂê¶Á¢∞Âà∞ËõáÂ§¥
                    if (mama.x === snakeHead.x && mama.y === snakeHead.y) {
                        gameOver('Â¶àÂ¶àÊäìÂà∞‰∫ÜÊù•Á¶èÔºÅ');
                        return;
                    }
                }
                
                mamaLastMoveTime = now;
            } catch (error) {
                console.error('Â¶àÂ¶àÁßªÂä®Â§±Ë¥•:', error);
            }
        }
        
        // Ê£ÄÊü•‰ΩçÁΩÆÊòØÂê¶Ë¢´ÈöúÁ¢çÁâ©Âç†Áî®ÔºàÂ¶àÂ¶à‰∏ìÁî®Ôºå‰∏çÊ£ÄÊü•ËõáË∫´ÂíåÈ£üÁâ©Ôºâ
        function isPositionOccupiedByObstacle(x, y) {
            try {
                const level = levels[currentLevel];
                if (level && level.obstacles) {
                    for (let obstacle of level.obstacles) {
                        if (obstacle.x === x && obstacle.y === y) return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Ê£ÄÊü•ÈöúÁ¢çÁâ©Âç†Áî®Â§±Ë¥•:', error);
                return false;
            }
        }



        

        // ÁîüÊàêÊéâËêΩÂ§ß‰æø
function dropPoop() {
    try {
        if (currentLevel !== 5 || !gameRunning) return;
        
        const now = Date.now();
        if (now - lastPoopDropTime < poopDropInterval) return;
        
        // ‰ªéÈ°∂ÈÉ®ÈöèÊú∫‰ΩçÁΩÆÂºÄÂßãÊéâËêΩ
        const x = Math.floor(Math.random() * tileCount);
        const newPoop = {x: x, y: 0, falling: true};
        
        // Á°Æ‰øù‰∏ç‰∏éËõáÂ§¥ÈáçÂè†
        if (snake[0].x !== x || snake[0].y !== 0) {
            fallingPoop.push(newPoop);
            lastPoopDropTime = now;
        }
    } catch (error) {
        console.error('ÊéâËêΩÂ§ß‰æøÂ§±Ë¥•:', error);
    }
}

// Êõ¥Êñ∞ÊéâËêΩÂ§ß‰æø‰ΩçÁΩÆ
function updateFallingPoop() {
    try {
        if (currentLevel !== 5 || !gameRunning) return;
        
        for (let i = fallingPoop.length - 1; i >= 0; i--) {
            const poop = fallingPoop[i];
            poop.y++;
            
            // Â§ß‰æøËêΩÂà∞Â∫ïÈÉ®Êó∂ÂÅúÊ≠¢ÊéâËêΩ
            if (poop.y >= tileCount - 1) {
                poop.falling = false;
            }
            
            // Ê£ÄÊü•‰∏éËõáÁöÑÁ¢∞Êíû
            for (let segment of snake) {
                if (poop.x === segment.x && poop.y === segment.y) {
                    if (currentLevel === 5) {
                        // ÈöêËóèÂÖ≥Âç°ÔºöÂêÉÂ§ß‰æøÂáèÈïøÂ∫¶
                        if (snake.length > 1) {
                            snake.pop(); // ÂáèÂ∞ë‰∏ÄËäÇË∫´‰Ωì
                            updateDebug('Êù•Á¶èÂêÉ‰∫ÜÊéâËêΩÁöÑÂ§ß‰æøÔºåË∫´‰ΩìÂèòÁü≠‰∫ÜÔºÅ');
                            // ÁßªÈô§Ëøô‰∏™Â§ß‰æø
                            fallingPoop.splice(i, 1);
                        } else {
                            // Âè™Ââ©Â§¥ÈÉ®Êó∂Ê∏∏ÊàèÁªìÊùü
                            gameOver('Êù•Á¶èÂè™Ââ©Â§¥ÈÉ®ËøòÂêÉÂ§ß‰æøÔºåË¢´Â¶àÂ¶àÊäì‰Ωè‰∫ÜÔºÅ');
                            return;
                        }
                    } else {
                        gameOver('Êù•Á¶èÂêÉ‰∫ÜÂ§ß‰æøË¢´Â¶àÂ¶àÊâì‰∫Ü‰∏ÄÈ°ø');
                        return;
                    }
                }
            }
        }
    } catch (error) {
        console.error('Êõ¥Êñ∞ÊéâËêΩÂ§ß‰æøÂ§±Ë¥•:', error);
    }
}

// ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜ
window.addEventListener('error', function(e) {
    console.error('ÂÖ®Â±ÄÈîôËØØ:', e.error);
    updateDebug('ÂèëÁîüÈîôËØØ: ' + e.message);
});
        // Á°Æ‰øùÂáΩÊï∞ÂÖ®Â±ÄÂèØËÆøÈóÆ
        window.showLevelSelect = showLevelSelect;
        window.startQuickGame = startQuickGame;
        window.resetProgress = resetProgress;
    </script>
</body>
</html>